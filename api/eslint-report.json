[{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\db\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":12,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[356,359],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[356,359],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":29,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[748,751],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[748,751],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { drizzle, type PostgresJsDatabase } from 'drizzle-orm/postgres-js'\nimport postgres from 'postgres'\nimport * as schema from './schema'\n\nconst connectionString = process.env.DATABASE_URL || 'postgres://localhost:5432/qr_order'\n\ntype DbType = PostgresJsDatabase<typeof schema>\n\nlet db: DbType\n\nfunction initDb() {\n  const maybeTestDb = (globalThis as any).__TEST_DB__ as DbType | undefined\n  if (process.env.NODE_ENV === 'test' && maybeTestDb) {\n    db = maybeTestDb\n    return\n  }\n  const client = postgres(connectionString, {\n    max: 10,\n    idle_timeout: 20,\n    connect_timeout: 10\n  })\n  db = drizzle(client, { schema })\n}\n\ninitDb()\n\nexport function setTestDb(mock: DbType) {\n  if (process.env.NODE_ENV === 'test') {\n    ;(globalThis as any).__TEST_DB__ = mock\n    db = mock\n  }\n}\n\nexport { db }\n\nexport * from './schema'\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\db\\schema.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":378,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":378,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12887,12890],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12887,12890],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\n  pgTable,\n  serial,\n  varchar,\n  text,\n  integer,\n  decimal,\n  boolean,\n  timestamp,\n  json,\n  pgEnum,\n  uniqueIndex,\n  index\n} from 'drizzle-orm/pg-core'\nimport { relations } from 'drizzle-orm'\n\n// ==================== 枚举类型 ====================\n\nexport const roleEnum = pgEnum('role', ['SUPER_ADMIN', 'OWNER', 'STAFF'])\nexport const statusEnum = pgEnum('status', ['ACTIVE', 'INACTIVE'])\nexport const storeStatusEnum = pgEnum('store_status', ['ACTIVE', 'CLOSED', 'DISABLED'])\nexport const tableStatusEnum = pgEnum('table_status', ['FREE', 'OCCUPIED', 'RESERVED'])\nexport const productTypeEnum = pgEnum('product_type', ['SINGLE', 'VARIANT'])\nexport const productStatusEnum = pgEnum('product_status', ['AVAILABLE', 'SOLDOUT', 'HIDDEN'])\nexport const printerTypeEnum = pgEnum('printer_type', ['KITCHEN', 'CASHIER', 'BAR'])\nexport const orderStatusEnum = pgEnum('order_status', [\n  'PENDING',\n  'PAID',\n  'PREPARING',\n  'COMPLETED',\n  'CANCELLED',\n  'REFUNDED'\n])\nexport const printJobStatusEnum = pgEnum('print_job_status', [\n  'PENDING',\n  'PRINTING',\n  'SUCCESS',\n  'FAILED',\n  'DEAD'\n])\n\n// 优惠券类型\nexport const couponTypeEnum = pgEnum('coupon_type', [\n  'FIXED', // 满减券（固定金额）\n  'PERCENT', // 折扣券（百分比）\n  'NO_THRESHOLD' // 无门槛券\n])\n\n// 优惠券状态\nexport const couponStatusEnum = pgEnum('coupon_status', ['ACTIVE', 'INACTIVE', 'EXPIRED'])\n\n// 用户优惠券状态\nexport const userCouponStatusEnum = pgEnum('user_coupon_status', ['UNUSED', 'USED', 'EXPIRED'])\n\n// 活动类型\nexport const promotionTypeEnum = pgEnum('promotion_type', [\n  'FULL_REDUCE', // 满减活动\n  'DISCOUNT', // 折扣活动\n  'NEW_USER', // 新人专享\n  'TIME_LIMITED', // 限时特价\n  'SECOND_HALF_PRICE', // 第二份半价\n  'QUANTITY_DISCOUNT', // 满件折扣\n  'BUY_ONE_GET_ONE' // 买一送一\n])\n\n// ==================== 用户与管理员 ====================\n\nexport const admins = pgTable(\n  'admins',\n  {\n    id: serial('id').primaryKey(),\n    username: varchar('username', { length: 50 }).notNull().unique(),\n    password: varchar('password', { length: 255 }).notNull(),\n    name: varchar('name', { length: 50 }).notNull(),\n    role: roleEnum('role').notNull().default('STAFF'),\n    storeId: integer('store_id').references(() => stores.id),\n    status: statusEnum('status').notNull().default('ACTIVE'),\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at')\n      .notNull()\n      .defaultNow()\n      .$onUpdate(() => new Date())\n  },\n  (table) => [uniqueIndex('admins_username_idx').on(table.username)]\n)\n\nexport const users = pgTable(\n  'users',\n  {\n    id: serial('id').primaryKey(),\n    openid: varchar('openid', { length: 100 }).notNull().unique(),\n    unionid: varchar('unionid', { length: 100 }),\n    nickname: varchar('nickname', { length: 50 }),\n    avatar: varchar('avatar', { length: 255 }),\n    phone: varchar('phone', { length: 20 }),\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at')\n      .notNull()\n      .defaultNow()\n      .$onUpdate(() => new Date())\n  },\n  (table) => [uniqueIndex('users_openid_idx').on(table.openid)]\n)\n\nexport const members = pgTable(\n  'members',\n  {\n    id: serial('id').primaryKey(),\n    userId: integer('user_id')\n      .notNull()\n      .unique()\n      .references(() => users.id),\n    level: integer('level').notNull().default(1),\n    points: integer('points').notNull().default(0),\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at')\n      .notNull()\n      .defaultNow()\n      .$onUpdate(() => new Date())\n  },\n  (table) => [uniqueIndex('members_user_id_idx').on(table.userId)]\n)\n\n// 门店会员子账户（每店独立的积分/等级）\nexport const storeMembers = pgTable(\n  'store_members',\n  {\n    id: serial('id').primaryKey(),\n    storeId: integer('store_id')\n      .notNull()\n      .references(() => stores.id, { onDelete: 'cascade' }),\n    userId: integer('user_id')\n      .notNull()\n      .references(() => users.id, { onDelete: 'cascade' }),\n    level: integer('level').notNull().default(1),\n    points: integer('points').notNull().default(0),\n    balance: decimal('balance', { precision: 10, scale: 2 }).default('0'), // 储值余额，后续可用\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at')\n      .notNull()\n      .defaultNow()\n      .$onUpdate(() => new Date())\n  },\n  (table) => [\n    uniqueIndex('store_members_store_user_idx').on(table.storeId, table.userId),\n    index('store_members_store_id_idx').on(table.storeId),\n    index('store_members_user_id_idx').on(table.userId)\n  ]\n)\n\n// ==================== 门店与桌台 ====================\n\nexport const stores = pgTable('stores', {\n  id: serial('id').primaryKey(),\n  name: varchar('name', { length: 100 }).notNull(),\n  address: varchar('address', { length: 255 }),\n  phone: varchar('phone', { length: 20 }),\n  latitude: decimal('latitude', { precision: 10, scale: 8 }),\n  longitude: decimal('longitude', { precision: 11, scale: 8 }),\n  logo: varchar('logo', { length: 255 }),\n  coverImage: varchar('cover_image', { length: 255 }), // 门店封面图\n  description: text('description'), // 门店简介\n  announcement: text('announcement'), // 店内公告\n  status: storeStatusEnum('status').notNull().default('ACTIVE'),\n\n  // 营业设置\n  businessHours: json('business_hours').$type<{\n    open: string // 开始时间 \"09:00\"\n    close: string // 结束时间 \"22:00\"\n    restDays?: number[] // 休息日 [0, 6] 表示周日和周六休息\n  }>(),\n\n  // 订单设置\n  minOrderAmount: decimal('min_order_amount', { precision: 10, scale: 2 }).default('0'), // 起订金额\n  serviceChargeRate: decimal('service_charge_rate', { precision: 5, scale: 4 }).default('0'), // 服务费率\n  autoConfirmOrder: boolean('auto_confirm_order').default(false), // 自动确认订单\n  autoCompleteMinutes: integer('auto_complete_minutes').default(60), // 自动完成时间(分钟)\n\n  // 便利设置\n  wifiName: varchar('wifi_name', { length: 50 }),\n  wifiPassword: varchar('wifi_password', { length: 50 }),\n  contactName: varchar('contact_name', { length: 50 }), // 联系人姓名\n  contactPhone: varchar('contact_phone', { length: 20 }), // 联系人电话\n\n  // 小程序设置\n  welcomeText: varchar('welcome_text', { length: 100 }).default('欢迎光临'), // 欢迎语\n  orderTip: text('order_tip'), // 点餐提示语\n\n  createdAt: timestamp('created_at').notNull().defaultNow(),\n  updatedAt: timestamp('updated_at')\n    .notNull()\n    .defaultNow()\n    .$onUpdate(() => new Date())\n})\n\nexport const tables = pgTable(\n  'tables',\n  {\n    id: serial('id').primaryKey(),\n    storeId: integer('store_id')\n      .notNull()\n      .references(() => stores.id),\n    name: varchar('name', { length: 50 }).notNull(),\n    capacity: integer('capacity').notNull().default(4),\n    qrCode: varchar('qr_code', { length: 100 }).notNull().unique(),\n    status: tableStatusEnum('status').notNull().default('FREE'),\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at')\n      .notNull()\n      .defaultNow()\n      .$onUpdate(() => new Date())\n  },\n  (table) => [\n    uniqueIndex('tables_qr_code_idx').on(table.qrCode),\n    index('tables_store_id_idx').on(table.storeId)\n  ]\n)\n\n// ==================== 商品与分类 ====================\n\nexport const categories = pgTable(\n  'categories',\n  {\n    id: serial('id').primaryKey(),\n    storeId: integer('store_id')\n      .notNull()\n      .references(() => stores.id),\n    name: varchar('name', { length: 50 }).notNull(),\n    sort: integer('sort').notNull().default(0),\n    icon: varchar('icon', { length: 255 }),\n    status: statusEnum('status').notNull().default('ACTIVE'),\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at')\n      .notNull()\n      .defaultNow()\n      .$onUpdate(() => new Date())\n  },\n  (table) => [index('categories_store_id_idx').on(table.storeId)]\n)\n\nexport const products = pgTable(\n  'products',\n  {\n    id: serial('id').primaryKey(),\n    storeId: integer('store_id')\n      .notNull()\n      .references(() => stores.id),\n    categoryId: integer('category_id')\n      .notNull()\n      .references(() => categories.id),\n    name: varchar('name', { length: 100 }).notNull(),\n    description: text('description'),\n    imageUrl: varchar('image_url', { length: 255 }),\n    type: productTypeEnum('type').notNull().default('SINGLE'),\n    basePrice: decimal('base_price', { precision: 10, scale: 2 }).notNull(),\n    sales: integer('sales').notNull().default(0),\n    sort: integer('sort').notNull().default(0),\n    status: productStatusEnum('status').notNull().default('AVAILABLE'),\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at')\n      .notNull()\n      .defaultNow()\n      .$onUpdate(() => new Date())\n  },\n  (table) => [\n    index('products_store_id_idx').on(table.storeId),\n    index('products_category_id_idx').on(table.categoryId)\n  ]\n)\n\nexport const productVariants = pgTable(\n  'product_variants',\n  {\n    id: serial('id').primaryKey(),\n    productId: integer('product_id')\n      .notNull()\n      .references(() => products.id, { onDelete: 'cascade' }),\n    specs: json('specs').$type<Record<string, string>>().notNull(),\n    price: decimal('price', { precision: 10, scale: 2 }).notNull(),\n    stock: integer('stock').notNull().default(-1),\n    status: statusEnum('status').notNull().default('ACTIVE'),\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at')\n      .notNull()\n      .defaultNow()\n      .$onUpdate(() => new Date())\n  },\n  (table) => [index('product_variants_product_id_idx').on(table.productId)]\n)\n\nexport const productAttributes = pgTable(\n  'product_attributes',\n  {\n    id: serial('id').primaryKey(),\n    productId: integer('product_id')\n      .notNull()\n      .references(() => products.id, { onDelete: 'cascade' }),\n    name: varchar('name', { length: 50 }).notNull(),\n    options: json('options').$type<string[]>().notNull(),\n    required: boolean('required').notNull().default(false),\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at')\n      .notNull()\n      .defaultNow()\n      .$onUpdate(() => new Date())\n  },\n  (table) => [index('product_attributes_product_id_idx').on(table.productId)]\n)\n\n// ==================== 打印机 ====================\n\nexport const printers = pgTable(\n  'printers',\n  {\n    id: serial('id').primaryKey(),\n    storeId: integer('store_id')\n      .notNull()\n      .references(() => stores.id),\n    sn: varchar('sn', { length: 100 }).notNull(),\n    key: varchar('key', { length: 100 }).notNull(),\n    name: varchar('name', { length: 50 }).notNull(),\n    type: printerTypeEnum('type').notNull().default('KITCHEN'),\n    status: statusEnum('status').notNull().default('ACTIVE'),\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at')\n      .notNull()\n      .defaultNow()\n      .$onUpdate(() => new Date())\n  },\n  (table) => [index('printers_store_id_idx').on(table.storeId)]\n)\n\nexport const categoryPrinters = pgTable(\n  'category_printers',\n  {\n    categoryId: integer('category_id')\n      .notNull()\n      .references(() => categories.id, { onDelete: 'cascade' }),\n    printerId: integer('printer_id')\n      .notNull()\n      .references(() => printers.id, { onDelete: 'cascade' })\n  },\n  (table) => [index('category_printers_idx').on(table.categoryId, table.printerId)]\n)\n\n// ==================== 订单 ====================\n\nexport const orders = pgTable(\n  'orders',\n  {\n    id: serial('id').primaryKey(),\n    orderNo: varchar('order_no', { length: 50 }).notNull().unique(),\n    storeId: integer('store_id')\n      .notNull()\n      .references(() => stores.id),\n    tableId: integer('table_id')\n      .notNull()\n      .references(() => tables.id),\n    userId: integer('user_id').references(() => users.id),\n    totalAmount: decimal('total_amount', { precision: 10, scale: 2 }).notNull(),\n    payAmount: decimal('pay_amount', { precision: 10, scale: 2 }).notNull(),\n    discount: decimal('discount', { precision: 10, scale: 2 }).notNull().default('0'),\n    // 新增字段\n    couponId: integer('coupon_id'), // 使用的优惠券ID\n    couponDiscount: decimal('coupon_discount', { precision: 10, scale: 2 }).default('0'),\n    promotionDiscount: decimal('promotion_discount', { precision: 10, scale: 2 }).default('0'),\n    pointsUsed: integer('points_used').default(0), // 使用的积分\n    pointsDiscount: decimal('points_discount', { precision: 10, scale: 2 }).default('0'),\n    dinersCount: integer('diners_count').default(1), // 就餐人数\n    tablewareFee: decimal('tableware_fee', { precision: 10, scale: 2 }).default('0'), // 餐具费\n    packingFee: decimal('packing_fee', { precision: 10, scale: 2 }).default('0'), // 打包费\n    status: orderStatusEnum('status').notNull().default('PENDING'),\n    payTime: timestamp('pay_time'),\n    remark: varchar('remark', { length: 255 }),\n    // 加菜相关\n    isAddition: boolean('is_addition').default(false), // 是否为加菜订单\n    parentOrderId: integer('parent_order_id'), // 主订单ID（加菜时使用）\n    promotionSnapshot: json('promotion_snapshot').$type<any[]>(), // 活动优惠快照\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at')\n      .notNull()\n      .defaultNow()\n      .$onUpdate(() => new Date())\n  },\n  (table) => [\n    uniqueIndex('orders_order_no_idx').on(table.orderNo),\n    index('orders_store_id_idx').on(table.storeId),\n    index('orders_table_id_idx').on(table.tableId),\n    index('orders_user_id_idx').on(table.userId),\n    index('orders_status_idx').on(table.status)\n  ]\n)\n\nexport const orderItems = pgTable(\n  'order_items',\n  {\n    id: serial('id').primaryKey(),\n    orderId: integer('order_id')\n      .notNull()\n      .references(() => orders.id, { onDelete: 'cascade' }),\n    productVariantId: integer('product_variant_id')\n      .notNull()\n      .references(() => productVariants.id),\n    quantity: integer('quantity').notNull(),\n    price: decimal('price', { precision: 10, scale: 2 }).notNull(),\n    snapshot: json('snapshot')\n      .$type<{ name: string; categoryName: string; specs: Record<string, string> }>()\n      .notNull(),\n    attributes: json('attributes').$type<{ name: string; value: string }[]>(),\n    // 退款相关\n    refundedQuantity: integer('refunded_quantity').default(0), // 已退款数量\n    refundedAmount: decimal('refunded_amount', { precision: 10, scale: 2 }).default('0'),\n    refundReason: varchar('refund_reason', { length: 255 }),\n    createdAt: timestamp('created_at').notNull().defaultNow()\n  },\n  (table) => [index('order_items_order_id_idx').on(table.orderId)]\n)\n\n// 积分流水（按门店隔离）\nexport const pointLogs = pgTable(\n  'point_logs',\n  {\n    id: serial('id').primaryKey(),\n    storeId: integer('store_id')\n      .notNull()\n      .references(() => stores.id, { onDelete: 'cascade' }),\n    userId: integer('user_id')\n      .notNull()\n      .references(() => users.id, { onDelete: 'cascade' }),\n    orderId: integer('order_id').references(() => orders.id, { onDelete: 'set null' }),\n    change: integer('change').notNull(), // 正数获取，负数扣减\n    reason: varchar('reason', { length: 100 }).notNull(),\n    meta: json('meta').$type<Record<string, unknown>>(), // 额外信息\n    createdAt: timestamp('created_at').notNull().defaultNow()\n  },\n  (table) => [\n    index('point_logs_store_user_idx').on(table.storeId, table.userId),\n    index('point_logs_order_id_idx').on(table.orderId)\n  ]\n)\n\nexport const printJobs = pgTable(\n  'print_jobs',\n  {\n    id: serial('id').primaryKey(),\n    orderId: integer('order_id')\n      .notNull()\n      .references(() => orders.id),\n    printerId: integer('printer_id')\n      .notNull()\n      .references(() => printers.id),\n    content: json('content').notNull(),\n    status: printJobStatusEnum('status').notNull().default('PENDING'),\n    retries: integer('retries').notNull().default(0),\n    error: text('error'),\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at')\n      .notNull()\n      .defaultNow()\n      .$onUpdate(() => new Date())\n  },\n  (table) => [\n    index('print_jobs_order_id_idx').on(table.orderId),\n    index('print_jobs_status_idx').on(table.status)\n  ]\n)\n\n// ==================== 关系定义 ====================\n\nexport const adminsRelations = relations(admins, ({ one }) => ({\n  store: one(stores, { fields: [admins.storeId], references: [stores.id] })\n}))\n\nexport const usersRelations = relations(users, ({ one, many }) => ({\n  member: one(members, { fields: [users.id], references: [members.userId] }),\n  storeMembers: many(storeMembers),\n  orders: many(orders)\n}))\n\nexport const membersRelations = relations(members, ({ one }) => ({\n  user: one(users, { fields: [members.userId], references: [users.id] })\n}))\n\nexport const storeMembersRelations = relations(storeMembers, ({ one }) => ({\n  store: one(stores, { fields: [storeMembers.storeId], references: [stores.id] }),\n  user: one(users, { fields: [storeMembers.userId], references: [users.id] })\n}))\n\nexport const storesRelations = relations(stores, ({ many }) => ({\n  admins: many(admins),\n  tables: many(tables),\n  categories: many(categories),\n  products: many(products),\n  printers: many(printers),\n  storeMembers: many(storeMembers),\n  orders: many(orders)\n}))\n\nexport const tablesRelations = relations(tables, ({ one, many }) => ({\n  store: one(stores, { fields: [tables.storeId], references: [stores.id] }),\n  orders: many(orders)\n}))\n\nexport const categoriesRelations = relations(categories, ({ one, many }) => ({\n  store: one(stores, { fields: [categories.storeId], references: [stores.id] }),\n  products: many(products),\n  printers: many(categoryPrinters)\n}))\n\nexport const productsRelations = relations(products, ({ one, many }) => ({\n  store: one(stores, { fields: [products.storeId], references: [stores.id] }),\n  category: one(categories, { fields: [products.categoryId], references: [categories.id] }),\n  variants: many(productVariants),\n  attributes: many(productAttributes)\n}))\n\nexport const productVariantsRelations = relations(productVariants, ({ one }) => ({\n  product: one(products, { fields: [productVariants.productId], references: [products.id] })\n}))\n\nexport const productAttributesRelations = relations(productAttributes, ({ one }) => ({\n  product: one(products, { fields: [productAttributes.productId], references: [products.id] })\n}))\n\nexport const printersRelations = relations(printers, ({ one, many }) => ({\n  store: one(stores, { fields: [printers.storeId], references: [stores.id] }),\n  categories: many(categoryPrinters),\n  printJobs: many(printJobs)\n}))\n\nexport const categoryPrintersRelations = relations(categoryPrinters, ({ one }) => ({\n  category: one(categories, { fields: [categoryPrinters.categoryId], references: [categories.id] }),\n  printer: one(printers, { fields: [categoryPrinters.printerId], references: [printers.id] })\n}))\n\nexport const ordersRelations = relations(orders, ({ one, many }) => ({\n  store: one(stores, { fields: [orders.storeId], references: [stores.id] }),\n  table: one(tables, { fields: [orders.tableId], references: [tables.id] }),\n  user: one(users, { fields: [orders.userId], references: [users.id] }),\n  items: many(orderItems),\n  printJobs: many(printJobs),\n  pointLogs: many(pointLogs)\n}))\n\nexport const orderItemsRelations = relations(orderItems, ({ one }) => ({\n  order: one(orders, { fields: [orderItems.orderId], references: [orders.id] }),\n  productVariant: one(productVariants, {\n    fields: [orderItems.productVariantId],\n    references: [productVariants.id]\n  })\n}))\n\nexport const printJobsRelations = relations(printJobs, ({ one }) => ({\n  order: one(orders, { fields: [printJobs.orderId], references: [orders.id] }),\n  printer: one(printers, { fields: [printJobs.printerId], references: [printers.id] })\n}))\n\nexport const pointLogsRelations = relations(pointLogs, ({ one }) => ({\n  store: one(stores, { fields: [pointLogs.storeId], references: [stores.id] }),\n  user: one(users, { fields: [pointLogs.userId], references: [users.id] }),\n  order: one(orders, { fields: [pointLogs.orderId], references: [orders.id] })\n}))\n\n// ==================== 系统设置 ====================\n\nexport const settings = pgTable('settings', {\n  id: serial('id').primaryKey(),\n  storeId: integer('store_id').references(() => stores.id, { onDelete: 'cascade' }),\n  key: varchar('key', { length: 100 }).notNull(),\n  value: text('value').notNull(),\n  description: varchar('description', { length: 255 }),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull()\n})\n\nexport const settingsRelations = relations(settings, ({ one }) => ({\n  store: one(stores, { fields: [settings.storeId], references: [stores.id] })\n}))\n\n// ==================== 优惠券系统 ====================\n\n// 优惠券模板表\nexport const coupons = pgTable(\n  'coupons',\n  {\n    id: serial('id').primaryKey(),\n    storeId: integer('store_id').references(() => stores.id, { onDelete: 'cascade' }),\n    name: varchar('name', { length: 100 }).notNull(),\n    type: couponTypeEnum('type').notNull().default('FIXED'),\n    value: decimal('value', { precision: 10, scale: 2 }).notNull(), // 优惠金额或折扣比例\n    minAmount: decimal('min_amount', { precision: 10, scale: 2 }).notNull().default('0'), // 最低消费金额\n    maxDiscount: decimal('max_discount', { precision: 10, scale: 2 }), // 最大优惠金额（折扣券用）\n    totalCount: integer('total_count').notNull().default(-1), // 发放总量，-1为不限\n    usedCount: integer('used_count').notNull().default(0), // 已使用数量\n    claimedCount: integer('claimed_count').notNull().default(0), // 已领取数量\n    perUserLimit: integer('per_user_limit').notNull().default(1), // 每人限领数量\n    startTime: timestamp('start_time').notNull(),\n    endTime: timestamp('end_time').notNull(),\n    description: text('description'),\n    status: couponStatusEnum('status').notNull().default('ACTIVE'),\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at')\n      .notNull()\n      .defaultNow()\n      .$onUpdate(() => new Date())\n  },\n  (table) => [\n    index('coupons_store_id_idx').on(table.storeId),\n    index('coupons_status_idx').on(table.status)\n  ]\n)\n\n// 用户优惠券表\nexport const userCoupons = pgTable(\n  'user_coupons',\n  {\n    id: serial('id').primaryKey(),\n    storeId: integer('store_id').references(() => stores.id, { onDelete: 'cascade' }),\n    userId: integer('user_id')\n      .notNull()\n      .references(() => users.id, { onDelete: 'cascade' }),\n    couponId: integer('coupon_id')\n      .notNull()\n      .references(() => coupons.id, { onDelete: 'cascade' }),\n    orderId: integer('order_id').references(() => orders.id), // 使用时关联的订单\n    status: userCouponStatusEnum('status').notNull().default('UNUSED'),\n    claimedAt: timestamp('claimed_at').notNull().defaultNow(),\n    usedAt: timestamp('used_at'),\n    expireAt: timestamp('expire_at').notNull() // 过期时间（可能和券模板不同）\n  },\n  (table) => [\n    index('user_coupons_store_id_idx').on(table.storeId),\n    index('user_coupons_user_id_idx').on(table.userId),\n    index('user_coupons_coupon_id_idx').on(table.couponId),\n    index('user_coupons_status_idx').on(table.status)\n  ]\n)\n\n// ==================== 营销活动系统 ====================\n\n// 活动表\nexport const promotions = pgTable(\n  'promotions',\n  {\n    id: serial('id').primaryKey(),\n    storeId: integer('store_id').references(() => stores.id, { onDelete: 'cascade' }),\n    name: varchar('name', { length: 100 }).notNull(),\n    type: promotionTypeEnum('type').notNull(),\n    // 规则示例：满减 [{\"min\": 50, \"discount\": 5}, {\"min\": 100, \"discount\": 15}]\n    // 折扣 {\"discount\": 0.8} 表示8折\n    rules: json('rules').$type<Record<string, unknown>>().notNull(),\n    startTime: timestamp('start_time').notNull(),\n    endTime: timestamp('end_time').notNull(),\n    description: text('description'),\n    priority: integer('priority').notNull().default(0), // 优先级，数值越大优先级越高\n    stackable: boolean('stackable').notNull().default(false), // 是否可叠加\n    status: statusEnum('status').notNull().default('ACTIVE'),\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at')\n      .notNull()\n      .defaultNow()\n      .$onUpdate(() => new Date())\n  },\n  (table) => [\n    index('promotions_store_id_idx').on(table.storeId),\n    index('promotions_status_idx').on(table.status)\n  ]\n)\n\n// ==================== 优惠券关系定义 ====================\n\nexport const couponsRelations = relations(coupons, ({ one, many }) => ({\n  store: one(stores, { fields: [coupons.storeId], references: [stores.id] }),\n  userCoupons: many(userCoupons)\n}))\n\nexport const userCouponsRelations = relations(userCoupons, ({ one }) => ({\n  user: one(users, { fields: [userCoupons.userId], references: [users.id] }),\n  coupon: one(coupons, { fields: [userCoupons.couponId], references: [coupons.id] }),\n  order: one(orders, { fields: [userCoupons.orderId], references: [orders.id] })\n}))\n\nexport const promotionsRelations = relations(promotions, ({ one }) => ({\n  store: one(stores, { fields: [promotions.storeId], references: [stores.id] })\n}))\n\n// ==================== 套餐/组合商品 ====================\n\n// 套餐表\nexport const combos = pgTable(\n  'combos',\n  {\n    id: serial('id').primaryKey(),\n    storeId: integer('store_id')\n      .notNull()\n      .references(() => stores.id, { onDelete: 'cascade' }),\n    name: varchar('name', { length: 100 }).notNull(),\n    description: text('description'),\n    imageUrl: varchar('image_url', { length: 255 }),\n    originalPrice: decimal('original_price', { precision: 10, scale: 2 }).notNull(), // 原价（单品总价）\n    price: decimal('price', { precision: 10, scale: 2 }).notNull(), // 套餐价\n    sales: integer('sales').notNull().default(0),\n    stock: integer('stock').notNull().default(-1), // -1为不限\n    sort: integer('sort').notNull().default(0),\n    status: productStatusEnum('status').notNull().default('AVAILABLE'),\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at')\n      .notNull()\n      .defaultNow()\n      .$onUpdate(() => new Date())\n  },\n  (table) => [\n    index('combos_store_id_idx').on(table.storeId),\n    index('combos_status_idx').on(table.status)\n  ]\n)\n\n// 套餐商品关联表\nexport const comboItems = pgTable(\n  'combo_items',\n  {\n    id: serial('id').primaryKey(),\n    comboId: integer('combo_id')\n      .notNull()\n      .references(() => combos.id, { onDelete: 'cascade' }),\n    productId: integer('product_id')\n      .notNull()\n      .references(() => products.id, { onDelete: 'cascade' }),\n    variantId: integer('variant_id').references(() => productVariants.id, { onDelete: 'set null' }), // 可选指定规格\n    quantity: integer('quantity').notNull().default(1),\n    // 是否可选（如套餐中可选择A或B）\n    isOptional: boolean('is_optional').notNull().default(false),\n    optionGroup: varchar('option_group', { length: 50 }) // 可选组（同组中选一个）\n  },\n  (table) => [index('combo_items_combo_id_idx').on(table.comboId)]\n)\n\nexport const combosRelations = relations(combos, ({ one, many }) => ({\n  store: one(stores, { fields: [combos.storeId], references: [stores.id] }),\n  items: many(comboItems)\n}))\n\nexport const comboItemsRelations = relations(comboItems, ({ one }) => ({\n  combo: one(combos, { fields: [comboItems.comboId], references: [combos.id] }),\n  product: one(products, { fields: [comboItems.productId], references: [products.id] }),\n  variant: one(productVariants, {\n    fields: [comboItems.variantId],\n    references: [productVariants.id]\n  })\n}))\n\n// ==================== 服务呼叫/催单 ====================\n\nexport const serviceCallTypeEnum = pgEnum('service_call_type', [\n  'CALL_SERVICE', // 呼叫服务员\n  'URGE_ORDER', // 催单\n  'REQUEST_BILL', // 请求结账\n  'OTHER' // 其他\n])\n\nexport const serviceCallStatusEnum = pgEnum('service_call_status', [\n  'PENDING', // 待处理\n  'ACCEPTED', // 已接受\n  'COMPLETED', // 已完成\n  'CANCELLED' // 已取消\n])\n\nexport const serviceCalls = pgTable(\n  'service_calls',\n  {\n    id: serial('id').primaryKey(),\n    storeId: integer('store_id')\n      .notNull()\n      .references(() => stores.id),\n    tableId: integer('table_id')\n      .notNull()\n      .references(() => tables.id),\n    orderId: integer('order_id').references(() => orders.id), // 催单时关联的订单\n    type: serviceCallTypeEnum('type').notNull(),\n    status: serviceCallStatusEnum('status').notNull().default('PENDING'),\n    message: varchar('message', { length: 255 }),\n    handledBy: integer('handled_by').references(() => admins.id), // 处理人\n    handledAt: timestamp('handled_at'),\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at')\n      .notNull()\n      .defaultNow()\n      .$onUpdate(() => new Date())\n  },\n  (table) => [\n    index('service_calls_store_id_idx').on(table.storeId),\n    index('service_calls_table_id_idx').on(table.tableId),\n    index('service_calls_status_idx').on(table.status)\n  ]\n)\n\nexport const serviceCallsRelations = relations(serviceCalls, ({ one }) => ({\n  store: one(stores, { fields: [serviceCalls.storeId], references: [stores.id] }),\n  table: one(tables, { fields: [serviceCalls.tableId], references: [tables.id] }),\n  order: one(orders, { fields: [serviceCalls.orderId], references: [orders.id] }),\n  handler: one(admins, { fields: [serviceCalls.handledBy], references: [admins.id] })\n}))\n\n// ==================== 操作日志 ====================\n\nexport const operationLogs = pgTable(\n  'operation_logs',\n  {\n    id: serial('id').primaryKey(),\n    storeId: integer('store_id').references(() => stores.id),\n    adminId: integer('admin_id').references(() => admins.id),\n    action: varchar('action', { length: 50 }).notNull(), // 操作类型\n    targetType: varchar('target_type', { length: 50 }), // 目标类型\n    targetId: integer('target_id'), // 目标ID\n    details: json('details').$type<Record<string, unknown>>(), // 详细信息\n    ip: varchar('ip', { length: 50 }),\n    createdAt: timestamp('created_at').notNull().defaultNow()\n  },\n  (table) => [\n    index('operation_logs_store_id_idx').on(table.storeId),\n    index('operation_logs_admin_id_idx').on(table.adminId),\n    index('operation_logs_created_at_idx').on(table.createdAt)\n  ]\n)\n\nexport const operationLogsRelations = relations(operationLogs, ({ one }) => ({\n  store: one(stores, { fields: [operationLogs.storeId], references: [stores.id] }),\n  admin: one(admins, { fields: [operationLogs.adminId], references: [admins.id] })\n}))\n\n// ==================== 角色权限配置 ====================\n\nexport const rolePermissions = pgTable(\n  'role_permissions',\n  {\n    id: serial('id').primaryKey(),\n    role: roleEnum('role').notNull(), // 角色\n    permissions: json('permissions').$type<string[]>().notNull().default([]), // 权限列表\n    description: text('description'), // 角色描述\n    updatedAt: timestamp('updated_at').notNull().defaultNow(),\n    updatedBy: integer('updated_by').references(() => admins.id) // 最后更新者\n  },\n  (table) => [uniqueIndex('role_permissions_role_idx').on(table.role)]\n)\n\n// ==================== Banner/轮播图管理 ====================\n\nexport const bannerPositionEnum = pgEnum('banner_position', [\n  'HOME_TOP', // 首页顶部轮播\n  'MENU_TOP', // 菜单页顶部\n  'CATEGORY', // 分类页\n  'PROMOTION' // 活动专区\n])\n\nexport const banners = pgTable('banners', {\n  id: serial('id').primaryKey(),\n  storeId: integer('store_id').references(() => stores.id), // null 表示全局\n  title: varchar('title', { length: 100 }).notNull(), // 标题\n  image: text('image').notNull(), // 图片URL\n  position: bannerPositionEnum('position').notNull().default('MENU_TOP'), // 展示位置\n  linkType: varchar('link_type', { length: 20 }), // 跳转类型: product/category/promotion/url\n  linkValue: varchar('link_value', { length: 255 }), // 跳转值\n  sort: integer('sort').notNull().default(0), // 排序\n  isActive: boolean('is_active').notNull().default(true), // 是否启用\n  startTime: timestamp('start_time'), // 开始时间\n  endTime: timestamp('end_time'), // 结束时间\n  createdAt: timestamp('created_at').notNull().defaultNow(),\n  updatedAt: timestamp('updated_at').notNull().defaultNow()\n})\n\nexport const bannersRelations = relations(banners, ({ one }) => ({\n  store: one(stores, { fields: [banners.storeId], references: [stores.id] })\n}))\n\n// ==================== 页面装修配置 ====================\n\n// 组件类型说明（实际类型存储在JSON中，支持动态扩展）\n// 极简组件: FOCUS_ENTRY, STAMP_CARD, COUPON_ENTRY, BALANCE_ENTRY, FLOAT_WINDOW, POINTS_ENTRY, SERVICE_ENTRY, NEARBY_STORES\n// 标准组件: BANNER, NAV_GRID, STORE_LIST, PRODUCT_LIST, PRODUCT_GRID, PROMOTION, STAMP_CARD_STD, WECHAT_OA, COMBO_PROMO, SEARCH, STORE_TITLE, CART_FLOAT, NOTICE, HOT_PRODUCTS, NEW_PRODUCTS, COUPON, SPACER\n// 自由容器: FREE_CONTAINER, FLOAT_CONTAINER\n// 基础元素: IMAGE, TEXT, USER_NICKNAME, USER_AVATAR, USER_PHONE, USER_POINTS, USER_BALANCE, COUPON_COUNT, STORE_NAME, STORE_DISTANCE, MEMBER_BADGE, MEMBER_PROGRESS\n// 专属组件: ORDER_COMPONENT, USER_INFO, FUNC_ENTRY, MEMBER_RIGHTS, MEMBER_LEVEL, RECHARGE_OPTIONS, RECHARGE_BUTTON\n\n// 页面类型说明\n// HOME, MENU, PRODUCT_DETAIL, ORDER_CENTER, PROFILE, MEMBER, BARRAGE, TABBAR, TOPIC, RECHARGE\n\n// 页面配置表\nexport const pageConfigs = pgTable(\n  'page_configs',\n  {\n    id: serial('id').primaryKey(),\n    storeId: integer('store_id')\n      .notNull()\n      .references(() => stores.id, { onDelete: 'cascade' }),\n    pageType: varchar('page_type', { length: 50 }).notNull().default('HOME'), // HOME/MENU/PROFILE/MEMBER等10种\n    components: json('components').$type<PageComponent[]>().notNull().default([]),\n    settings: json('settings').$type<PageSettings>(), // 页面级设置\n    isPublished: boolean('is_published').notNull().default(false), // 是否已发布\n    publishedAt: timestamp('published_at'), // 发布时间\n    createdAt: timestamp('created_at').notNull().defaultNow(),\n    updatedAt: timestamp('updated_at')\n      .notNull()\n      .defaultNow()\n      .$onUpdate(() => new Date())\n  },\n  (table) => [\n    index('page_configs_store_id_idx').on(table.storeId),\n    uniqueIndex('page_configs_store_page_idx').on(table.storeId, table.pageType)\n  ]\n)\n\n// 页面组件类型定义\nexport interface PageComponent {\n  id: string // 组件唯一ID (uuid)\n  type: string // 组件类型\n  title?: string // 组件标题\n  visible: boolean // 是否显示\n  props: Record<string, unknown> // 组件配置属性\n  children?: PageComponent[] // 子组件（自由容器用）\n  // 自由画布布局属性\n  x?: number // X 坐标\n  y?: number // Y 坐标\n  width?: number // 宽度\n  height?: number // 高度\n  zIndex?: number // 层级（用于排序和显示顺序）\n  locked?: boolean // 是否锁定（锁定后不能拖拽和调整大小）\n}\n\n// 页面设置\nexport interface PageSettings {\n  title?: string // 页面标题\n  navBgColor?: string // 导航背景色\n  navTextColor?: 'white' | 'black' // 导航文字颜色\n  pageBgColor?: string // 页面背景色\n  hideNav?: boolean // 隐藏导航\n  enablePullRefresh?: boolean // 下拉刷新\n}\n\nexport const pageConfigsRelations = relations(pageConfigs, ({ one }) => ({\n  store: one(stores, { fields: [pageConfigs.storeId], references: [stores.id] })\n}))\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\lib\\auth.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":363,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":363,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8069,8072],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8069,8072],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":363,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":363,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8097,8100],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8097,8100],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Elysia } from 'elysia'\nimport { jwt } from '@elysiajs/jwt'\nimport { eq } from 'drizzle-orm'\nimport { error } from './utils'\n\n// ==================== 类型定义 ====================\n\n// 角色类型\nexport type Role = 'SUPER_ADMIN' | 'OWNER' | 'STAFF'\n\n// 权限类型 - 资源:操作\nexport type Permission =\n  // 门店\n  | 'store:read'\n  | 'store:write'\n  | 'store:delete'\n  // 桌台\n  | 'table:read'\n  | 'table:write'\n  | 'table:delete'\n  // 分类\n  | 'category:read'\n  | 'category:write'\n  | 'category:delete'\n  // 商品\n  | 'product:read'\n  | 'product:write'\n  | 'product:delete'\n  // 订单\n  | 'order:read'\n  | 'order:write'\n  | 'order:refund'\n  // 打印机\n  | 'printer:read'\n  | 'printer:write'\n  | 'printer:delete'\n  // 会员\n  | 'member:read'\n  | 'member:write'\n  // 优惠券\n  | 'coupon:read'\n  | 'coupon:write'\n  | 'coupon:delete'\n  // 营销活动\n  | 'promotion:read'\n  | 'promotion:write'\n  | 'promotion:delete'\n  // 员工\n  | 'staff:read'\n  | 'staff:write'\n  | 'staff:delete'\n  // 系统设置\n  | 'settings:read'\n  | 'settings:write'\n  // 数据报表\n  | 'report:read'\n  // 服务呼叫\n  | 'service:read'\n  | 'service:write'\n  // 轮播图\n  | 'banners:read'\n  | 'banners:create'\n  | 'banners:update'\n  | 'banners:delete'\n  // 上传\n  | 'upload:write'\n\n// 所有权限列表（用于前端展示和验证）\nexport const ALL_PERMISSIONS: Permission[] = [\n  'store:read',\n  'store:write',\n  'store:delete',\n  'table:read',\n  'table:write',\n  'table:delete',\n  'category:read',\n  'category:write',\n  'category:delete',\n  'product:read',\n  'product:write',\n  'product:delete',\n  'order:read',\n  'order:write',\n  'order:refund',\n  'printer:read',\n  'printer:write',\n  'printer:delete',\n  'member:read',\n  'member:write',\n  'coupon:read',\n  'coupon:write',\n  'coupon:delete',\n  'promotion:read',\n  'promotion:write',\n  'promotion:delete',\n  'staff:read',\n  'staff:write',\n  'staff:delete',\n  'settings:read',\n  'settings:write',\n  'report:read',\n  'service:read',\n  'service:write',\n  'banners:read',\n  'banners:create',\n  'banners:update',\n  'banners:delete',\n  'upload:write'\n]\n\n// JWT Payload 类型\nexport interface JWTPayload {\n  id: number\n  username: string\n  role: Role\n  storeId: number | null\n}\n\n// ==================== RBAC 权限矩阵 ====================\n\n// 角色拥有的权限\nexport const ROLE_PERMISSIONS: Record<Role, Permission[]> = {\n  SUPER_ADMIN: [\n    // 超级管理员拥有所有权限\n    'store:read',\n    'store:write',\n    'store:delete',\n    'table:read',\n    'table:write',\n    'table:delete',\n    'category:read',\n    'category:write',\n    'category:delete',\n    'product:read',\n    'product:write',\n    'product:delete',\n    'order:read',\n    'order:write',\n    'order:refund',\n    'printer:read',\n    'printer:write',\n    'printer:delete',\n    'member:read',\n    'member:write',\n    'coupon:read',\n    'coupon:write',\n    'coupon:delete',\n    'promotion:read',\n    'promotion:write',\n    'promotion:delete',\n    'staff:read',\n    'staff:write',\n    'staff:delete',\n    'settings:read',\n    'settings:write',\n    'report:read',\n    'service:read',\n    'service:write',\n    'upload:write'\n  ],\n  OWNER: [\n    // 店长拥有除门店管理外的所有权限\n    'store:read', // 只能读取自己门店\n    'table:read',\n    'table:write',\n    'table:delete',\n    'category:read',\n    'category:write',\n    'category:delete',\n    'product:read',\n    'product:write',\n    'product:delete',\n    'order:read',\n    'order:write',\n    'order:refund',\n    'printer:read',\n    'printer:write',\n    'printer:delete',\n    'member:read',\n    'member:write',\n    'coupon:read',\n    'coupon:write',\n    'coupon:delete',\n    'promotion:read',\n    'promotion:write',\n    'promotion:delete',\n    'staff:read',\n    'staff:write', // 可以管理本店员工\n    'settings:read',\n    'settings:write',\n    'report:read',\n    'service:read',\n    'service:write',\n    'upload:write'\n  ],\n  STAFF: [\n    // 员工只有基础操作权限\n    'table:read',\n    'category:read',\n    'product:read',\n    'order:read',\n    'order:write', // 可以处理订单\n    'printer:read',\n    'service:read',\n    'service:write' // 可以处理服务呼叫\n  ]\n}\n\n/**\n * 从数据库获取角色权限（带缓存和回退到默认值）\n * 这是异步函数，需要在登录/获取用户信息时调用\n */\nexport async function getRolePermissions(role: Role): Promise<Permission[]> {\n  try {\n    // 动态导入避免循环依赖\n    const { db, rolePermissions } = await import('../db')\n\n    const [config] = await db\n      .select()\n      .from(rolePermissions)\n      .where(eq(rolePermissions.role, role))\n      .limit(1)\n\n    if (config && config.permissions && config.permissions.length > 0) {\n      return config.permissions as Permission[]\n    }\n  } catch {\n    // 数据库错误时回退到默认值\n    console.warn(`Failed to get permissions from DB for role ${role}, using defaults`)\n  }\n\n  // 回退到默认权限\n  return ROLE_PERMISSIONS[role] || []\n}\n\n// 检查角色是否拥有权限\nexport function hasPermission(role: Role, permission: Permission): boolean {\n  return ROLE_PERMISSIONS[role]?.includes(permission) ?? false\n}\n\n// 检查角色是否拥有任意一个权限\nexport function hasAnyPermission(role: Role, permissions: Permission[]): boolean {\n  return permissions.some((p) => hasPermission(role, p))\n}\n\n// 检查角色是否拥有所有权限\nexport function hasAllPermissions(role: Role, permissions: Permission[]): boolean {\n  return permissions.every((p) => hasPermission(role, p))\n}\n\n// ==================== 便捷角色检查 ====================\n\nexport const ROLES = {\n  // 所有登录用户\n  authenticated: ['SUPER_ADMIN', 'OWNER', 'STAFF'] as Role[],\n  // 店长及以上\n  manager: ['SUPER_ADMIN', 'OWNER'] as Role[],\n  // 仅超级管理员\n  admin: ['SUPER_ADMIN'] as Role[]\n}\n\n// 创建 JWT 插件实例\nexport const jwtPlugin = jwt({\n  name: 'jwt',\n  secret: process.env.JWT_SECRET || 'your-super-secret-key-change-in-production'\n})\n\n// 认证中间件 - 验证 token 并提取用户信息\nexport const authPlugin = new Elysia({ name: 'auth' })\n  .use(jwtPlugin)\n  .derive({ as: 'global' }, async ({ headers, jwt }) => {\n    const authorization = headers.authorization\n\n    if (!authorization?.startsWith('Bearer ')) {\n      return { user: null }\n    }\n\n    const token = authorization.slice(7)\n\n    try {\n      const payload = await jwt.verify(token)\n      if (!payload) {\n        return { user: null }\n      }\n      return { user: payload as unknown as JWTPayload }\n    } catch {\n      return { user: null }\n    }\n  })\n\n// 需要登录的守卫\nexport const requireAuth = new Elysia({ name: 'requireAuth' })\n  .use(authPlugin)\n  .onBeforeHandle(({ user }) => {\n    if (!user) {\n      return error('未授权，请先登录', 401)\n    }\n  })\n\n// 需要特定角色的守卫\nexport const requireRole = (allowedRoles: Role[]) => {\n  return new Elysia({ name: `requireRole:${allowedRoles.join(',')}` })\n    .use(authPlugin)\n    .onBeforeHandle(({ user }) => {\n      if (!user) {\n        return error('未授权，请先登录', 401)\n      }\n      if (!allowedRoles.includes(user.role)) {\n        return error('权限不足', 403)\n      }\n    })\n}\n\n// 便捷的角色守卫\nexport const requireManager = requireRole(ROLES.manager)\nexport const requireAdmin = requireRole(ROLES.admin)\n\n// 需要特定权限的守卫\nexport const requirePermission = (requiredPermissions: Permission | Permission[]) => {\n  const permissions = Array.isArray(requiredPermissions)\n    ? requiredPermissions\n    : [requiredPermissions]\n  return new Elysia({ name: `requirePermission:${permissions.join(',')}` })\n    .use(authPlugin)\n    .onBeforeHandle(({ user }) => {\n      if (!user) {\n        return error('未授权，请先登录', 401)\n      }\n      if (!hasAnyPermission(user.role, permissions)) {\n        return error(`权限不足，需要: ${permissions.join(' 或 ')}`, 403)\n      }\n    })\n}\n\n// 需要所有指定权限的守卫\nexport const requireAllPermissions = (requiredPermissions: Permission[]) => {\n  return new Elysia({ name: `requireAllPermissions:${requiredPermissions.join(',')}` })\n    .use(authPlugin)\n    .onBeforeHandle(({ user }) => {\n      if (!user) {\n        return error('未授权，请先登录', 401)\n      }\n      if (!hasAllPermissions(user.role, requiredPermissions)) {\n        return error(`权限不足，需要: ${requiredPermissions.join(' 和 ')}`, 403)\n      }\n    })\n}\n\n// 门店数据隔离守卫 - 确保用户只能访问自己门店的数据\nexport const requireStoreAccess = new Elysia({ name: 'requireStoreAccess' })\n  .use(authPlugin)\n  .onBeforeHandle(({ user, query, params }) => {\n    if (!user) {\n      return error('未授权，请先登录', 401)\n    }\n\n    // 超级管理员可以访问所有门店\n    if (user.role === 'SUPER_ADMIN') {\n      return\n    }\n\n    // 检查请求中的 storeId 是否与用户所属门店匹配\n    const requestStoreId = (query as any)?.storeId || (params as any)?.storeId\n\n    if (requestStoreId && Number(requestStoreId) !== user.storeId) {\n      return error('无权访问该门店数据', 403)\n    }\n  })\n\n// 获取用户可访问的门店 ID\nexport function getAccessibleStoreId(\n  user: JWTPayload | null,\n  requestedStoreId?: number\n): number | null {\n  if (!user) return null\n\n  // 超级管理员可以指定任意门店，默认返回请求的或 1\n  if (user.role === 'SUPER_ADMIN') {\n    return requestedStoreId || 1\n  }\n\n  // 其他角色只能访问自己的门店\n  return user.storeId\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\lib\\operation-log.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\lib\\redis.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":6,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[102,105],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[102,105],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":52,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1291,1294],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1291,1294],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":53,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1340,1343],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1340,1343],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Redis from 'ioredis'\n\nlet redis: Redis | null = null\n\ntry {\n  const testRedis = (globalThis as any).__TEST_REDIS__\n  if (process.env.NODE_ENV === 'test' && testRedis) {\n    // In tests we inject an in-memory stub via global flag.\n    redis = testRedis\n  } else {\n    redis = new Redis(process.env.REDIS_URL || 'redis://localhost:6379', {\n      maxRetriesPerRequest: 3,\n      retryStrategy: (times) => {\n        if (times > 3) {\n          console.warn('⚠️ Redis unavailable, running without cache')\n          return null // 停止重试\n        }\n        return Math.min(times * 100, 3000)\n      },\n      lazyConnect: true\n    })\n\n    redis.on('connect', () => {\n      console.log('✅ Redis connected')\n    })\n\n    redis.on('error', () => {\n      // 静默处理错误，避免刷屏\n    })\n\n    // 尝试连接\n    redis.connect().catch(() => {\n      console.warn('⚠️ Redis connection failed, running without cache')\n      redis = null\n    })\n  }\n} catch {\n  console.warn('⚠️ Redis unavailable, running without cache')\n  redis = null\n}\n\nexport default redis\n\n// For tests: allow swapping redis instance after module load.\nexport function setTestRedis(mock: Redis | null) {\n  if (process.env.NODE_ENV === 'test') {\n    redis = mock\n  }\n}\n\nexport function getRedis() {\n  if (process.env.NODE_ENV === 'test' && (globalThis as any).__TEST_REDIS__) {\n    return (globalThis as any).__TEST_REDIS__ as Redis | null\n  }\n  return redis\n}\n\n// 购物车相关 Key 生成\nexport const cartKey = (storeId: number, tableId: number) => `cart:${storeId}:${tableId}`\n\n// 桌台 WebSocket 房间 Key\nexport const tableRoomKey = (storeId: number, tableId: number) => `room:table:${storeId}:${tableId}`\n\n// 打印任务 Stream Key\nexport const PRINT_STREAM_KEY = 'stream:print_jobs'\n\n// 订单事件 Stream Key\nexport const ORDER_STREAM_KEY = 'stream:order_events'\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\banners.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\cart.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\categories.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\combos.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\coupons.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\dashboard.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\members.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'redis' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'memberQuery' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":144,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":144,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Elysia, t } from 'elysia'\nimport { eq, and, desc, count, sql, like, gte, lte } from 'drizzle-orm'\nimport { db, members, users, orders, storeMembers } from '../db'\nimport { success, error, pagination } from '../lib/utils'\nimport { requirePermission, hasPermission } from '../lib/auth'\nimport redis, { getRedis } from '../lib/redis'\nimport { logOperation } from '../lib/operation-log'\n\n// 积分规则：每消费1元获得1积分\nconst POINTS_PER_YUAN = 1\n// 积分抵扣：100积分抵扣1元\nconst POINTS_TO_YUAN = 100\nconst MEMBER_RATE_PREFIX = 'rate:member:'\nconst MEMBER_IDEM_PREFIX = 'idem:member:'\nconst MEMBER_RATE_LIMIT = { limit: 10, ttl: 60 }\n\ntype IdempotencyResult = { ok: false; message: string } | { ok: true; redisKey?: string }\n\nfunction getClientIp(headers: Record<string, string | undefined>) {\n  return (\n    headers['x-forwarded-for']?.split(',')[0]?.trim() ||\n    headers['x-real-ip'] ||\n    headers['cf-connecting-ip'] ||\n    'unknown'\n  )\n}\n\nasync function checkRateLimit(key: string) {\n  const client = getRedis()\n  if (!client) return true\n  const count = await client.incr(key)\n  if (count === 1) await client.expire(key, MEMBER_RATE_LIMIT.ttl)\n  if (process.env.NODE_ENV === 'test') {\n    console.log('[test] member rate key', key, 'count', count)\n  }\n  return count <= MEMBER_RATE_LIMIT.limit\n}\n\nasync function ensureIdempotent(key?: string): Promise<IdempotencyResult> {\n  const client = getRedis()\n  if (!key || !client) return { ok: true }\n  const existing = await client.get(key)\n  if (existing) return { ok: false, message: '重复请求，请勿重复提交' }\n  await client.set(key, 'processing', 'EX', 600, 'NX')\n  return { ok: true, redisKey: key }\n}\n\nasync function finalizeIdempotent(redisKey?: string) {\n  const client = getRedis()\n  if (client && redisKey) {\n    await client.set(redisKey, 'done', 'EX', 600)\n  }\n}\n\nasync function releaseIdempotent(redisKey?: string) {\n  const client = getRedis()\n  if (client && redisKey) {\n    await client.del(redisKey)\n  }\n}\n\nasync function ensureStoreMember(storeId: number, userId: number) {\n  const [existing] = await db\n    .select()\n    .from(storeMembers)\n    .where(and(eq(storeMembers.storeId, storeId), eq(storeMembers.userId, userId)))\n    .limit(1)\n\n  if (existing) return existing\n\n  const [created] = await db\n    .insert(storeMembers)\n    .values({ storeId, userId, level: 1, points: 0 })\n    .returning()\n  return created\n}\n\nexport const memberRoutes = new Elysia({ prefix: '/api/members' })\n  // 会员读取需要 member:read 权限\n  .use(requirePermission('member:read'))\n  // 获取所有用户列表（管理端）\n  .get(\n    '/users',\n    async ({ query }) => {\n      const { page, pageSize, keyword, hasPhone } = query\n      const { take, skip } = pagination(page, pageSize)\n\n      const conditions = []\n      if (keyword) {\n        conditions.push(like(users.nickname, `%${keyword}%`))\n      }\n      if (hasPhone === true) {\n        conditions.push(sql`${users.phone} IS NOT NULL AND ${users.phone} != ''`)\n      }\n\n      const whereClause = conditions.length > 0 ? and(...conditions) : undefined\n\n      const [userList, totalResult] = await Promise.all([\n        db\n          .select({\n            user: users,\n            member: members\n          })\n          .from(users)\n          .leftJoin(members, eq(users.id, members.userId))\n          .where(whereClause)\n          .orderBy(desc(users.createdAt))\n          .limit(take)\n          .offset(skip),\n        db.select({ count: count() }).from(users).where(whereClause)\n      ])\n\n      return success({\n        list: userList.map(\n          (r: { user: typeof users.$inferSelect; member: typeof members.$inferSelect | null }) => ({\n            ...r.user,\n            member: r.member\n          })\n        ),\n        total: totalResult[0]?.count ?? 0,\n        page: page || 1,\n        pageSize: take\n      })\n    },\n    {\n      query: t.Object({\n        page: t.Optional(t.Number()),\n        pageSize: t.Optional(t.Number()),\n        keyword: t.Optional(t.String()),\n        hasPhone: t.Optional(t.Boolean())\n      }),\n      detail: { tags: ['Members'], summary: '获取所有用户列表' }\n    }\n  )\n\n  // 获取会员列表（管理端）\n  .get(\n    '/',\n    async ({ query }) => {\n      const { page, pageSize, keyword, level, minPoints, maxPoints } = query\n      const { take, skip } = pagination(page, pageSize)\n\n      // 构建查询条件\n      const memberQuery = db\n        .select({\n          member: members,\n          user: users\n        })\n        .from(members)\n        .leftJoin(users, eq(members.userId, users.id))\n\n      // 根据关键词搜索用户昵称或手机号\n      const conditions = []\n      if (keyword) {\n        conditions.push(\n          sql`(${users.nickname} LIKE ${'%' + keyword + '%'} OR ${users.phone} LIKE ${'%' + keyword + '%'})`\n        )\n      }\n      if (level) {\n        conditions.push(eq(members.level, level))\n      }\n      if (minPoints !== undefined) {\n        conditions.push(gte(members.points, minPoints))\n      }\n      if (maxPoints !== undefined) {\n        conditions.push(lte(members.points, maxPoints))\n      }\n\n      const whereClause = conditions.length > 0 ? and(...conditions) : undefined\n\n      const [memberList, totalResult] = await Promise.all([\n        db\n          .select({\n            member: members,\n            user: users\n          })\n          .from(members)\n          .leftJoin(users, eq(members.userId, users.id))\n          .where(whereClause)\n          .orderBy(desc(members.points), desc(members.createdAt))\n          .limit(take)\n          .offset(skip),\n        db\n          .select({ count: count() })\n          .from(members)\n          .where(level ? eq(members.level, level) : undefined)\n      ])\n\n      // 获取每个会员的消费统计\n      const result = await Promise.all(\n        memberList.map(\n          async (r: {\n            member: typeof members.$inferSelect\n            user: typeof users.$inferSelect | null\n          }) => {\n            const [stats] = await db\n              .select({\n                totalOrders: count(),\n                totalAmount: sql<string>`COALESCE(SUM(${orders.payAmount}), 0)`\n              })\n              .from(orders)\n              .where(eq(orders.userId, r.member.userId))\n\n            return {\n              ...r.member,\n              user: r.user,\n              stats: {\n                totalOrders: stats?.totalOrders ?? 0,\n                totalAmount: Number(stats?.totalAmount || 0)\n              }\n            }\n          }\n        )\n      )\n\n      return success({\n        list: result,\n        total: totalResult[0]?.count ?? 0,\n        page: page || 1,\n        pageSize: take\n      })\n    },\n    {\n      query: t.Object({\n        page: t.Optional(t.Number()),\n        pageSize: t.Optional(t.Number()),\n        keyword: t.Optional(t.String()),\n        level: t.Optional(t.Number()),\n        minPoints: t.Optional(t.Number()),\n        maxPoints: t.Optional(t.Number())\n      }),\n      detail: { tags: ['Members'], summary: '获取会员列表' }\n    }\n  )\n\n  // 获取会员详情\n  .get(\n    '/:id',\n    async ({ params }) => {\n      const [member] = await db\n        .select({\n          member: members,\n          user: users\n        })\n        .from(members)\n        .leftJoin(users, eq(members.userId, users.id))\n        .where(eq(members.id, params.id))\n        .limit(1)\n\n      if (!member) return error('会员不存在', 404)\n\n      // 获取消费统计\n      const [orderStats] = await db\n        .select({\n          totalOrders: count(),\n          totalAmount: sql<string>`COALESCE(SUM(${orders.payAmount}), 0)`\n        })\n        .from(orders)\n        .where(eq(orders.userId, member.member.userId))\n\n      return success({\n        ...member.member,\n        user: member.user,\n        stats: {\n          totalOrders: orderStats?.totalOrders ?? 0,\n          totalAmount: Number(orderStats?.totalAmount || 0)\n        }\n      })\n    },\n    {\n      params: t.Object({ id: t.Number() }),\n      detail: { tags: ['Members'], summary: '获取会员详情' }\n    }\n  )\n\n  // 通过用户ID获取会员信息\n  .get(\n    '/user/:userId',\n    async ({ params, query }) => {\n      const storeId = query.storeId\n      const [member] = await db\n        .select({\n          member: members,\n          user: users\n        })\n        .from(members)\n        .leftJoin(users, eq(members.userId, users.id))\n        .where(eq(members.userId, params.userId))\n        .limit(1)\n\n      if (!member) {\n        // 自动创建会员\n        const [newMember] = await db\n          .insert(members)\n          .values({\n            userId: params.userId,\n            level: 1,\n            points: 0\n          })\n          .returning()\n\n        const [user] = await db.select().from(users).where(eq(users.id, params.userId)).limit(1)\n\n        return success({\n          ...newMember,\n          user,\n          isNew: true\n        })\n      }\n\n      let storeMember\n      if (storeId) {\n        storeMember = await ensureStoreMember(storeId, params.userId)\n      }\n\n      return success({\n        ...member.member,\n        user: member.user,\n        storeMember: storeMember ?? null\n      })\n    },\n    {\n      params: t.Object({ userId: t.Number() }),\n      query: t.Object({ storeId: t.Optional(t.Number()) }),\n      detail: { tags: ['Members'], summary: '通过用户ID获取会员信息' }\n    }\n  )\n\n  // 获取积分规则\n  .get(\n    '/points/rules',\n    async () => {\n      return success({\n        earnRate: POINTS_PER_YUAN, // 每消费1元获得积分\n        redeemRate: POINTS_TO_YUAN, // 多少积分抵扣1元\n        minRedeemPoints: 100, // 最低使用积分\n        maxRedeemPercent: 0.5 // 最多抵扣订单金额的比例\n      })\n    },\n    {\n      detail: { tags: ['Members'], summary: '获取积分规则' }\n    }\n  )\n\n  // 计算积分可抵扣金额\n  .post(\n    '/points/calculate',\n    async ({ body }) => {\n      const { userId, orderAmount, pointsToUse } = body\n\n      // 获取会员积分\n      const [member] = await db.select().from(members).where(eq(members.userId, userId)).limit(1)\n\n      if (!member) {\n        return success({\n          availablePoints: 0,\n          maxUsablePoints: 0,\n          discount: 0,\n          message: '非会员用户'\n        })\n      }\n\n      const availablePoints = member.points\n\n      // 计算最大可用积分（不超过订单金额的50%对应的积分）\n      const maxDiscountAmount = orderAmount * 0.5\n      const maxPointsForDiscount = Math.floor(maxDiscountAmount * POINTS_TO_YUAN)\n      const maxUsablePoints = Math.min(availablePoints, maxPointsForDiscount)\n\n      // 计算实际使用积分\n      const actualPointsToUse = pointsToUse ? Math.min(pointsToUse, maxUsablePoints) : 0\n\n      // 计算抵扣金额\n      const discount = actualPointsToUse / POINTS_TO_YUAN\n\n      return success({\n        availablePoints,\n        maxUsablePoints,\n        pointsToUse: actualPointsToUse,\n        discount: Math.round(discount * 100) / 100,\n        finalAmount: Math.round((orderAmount - discount) * 100) / 100\n      })\n    },\n    {\n      body: t.Object({\n        userId: t.Number(),\n        orderAmount: t.Number({ minimum: 0 }),\n        pointsToUse: t.Optional(t.Number({ minimum: 0 }))\n      }),\n      detail: { tags: ['Members'], summary: '计算积分抵扣' }\n    }\n  )\n\n  // 使用积分（下单时调用）\n  .post(\n    '/points/use',\n    async ({ body, headers, user }) => {\n      if (!user || !hasPermission(user.role, 'member:write')) {\n        return error('权限不足，需要 member:write', 403)\n      }\n\n      const ip = getClientIp(headers as Record<string, string | undefined>)\n      const rateKey = `${MEMBER_RATE_PREFIX}use:${user.id || ip}`\n      if (!(await checkRateLimit(rateKey))) {\n        return error('操作过于频繁，请稍后重试', 429)\n      }\n\n      const idempotencyKey = headers['idempotency-key'] as string | undefined\n      const idemKey = idempotencyKey ? `${MEMBER_IDEM_PREFIX}use:${idempotencyKey}` : undefined\n      const idemResult = await ensureIdempotent(idemKey)\n      if (!idemResult.ok) {\n        return error(idemResult.message || '重复请求', 409)\n      }\n\n      const { userId, points, orderId, description } = body\n\n      const [member] = await db.select().from(members).where(eq(members.userId, userId)).limit(1)\n\n      if (!member) {\n        await releaseIdempotent(idemResult.redisKey)\n        return error('会员不存在', 404)\n      }\n\n      if (member.points < points) {\n        await releaseIdempotent(idemResult.redisKey)\n        return error('积分不足', 400)\n      }\n\n      // 扣除积分\n      const [updated] = await db\n        .update(members)\n        .set({\n          points: sql`${members.points} - ${points}`\n        })\n        .where(eq(members.userId, userId))\n        .returning()\n\n      await logOperation({\n        adminId: user.id,\n        action: 'points_use',\n        targetType: 'member',\n        targetId: member.id,\n        storeId: null,\n        details: { userId, points, orderId, description }\n      })\n\n      await finalizeIdempotent(idemResult.redisKey)\n\n      return success(\n        {\n          ...updated,\n          pointsUsed: points,\n          discount: points / POINTS_TO_YUAN\n        },\n        '积分使用成功'\n      )\n    },\n    {\n      body: t.Object({\n        userId: t.Number(),\n        points: t.Number({ minimum: 1 }),\n        orderId: t.Optional(t.Number()),\n        description: t.Optional(t.String())\n      }),\n      detail: { tags: ['Members'], summary: '使用积分' }\n    }\n  )\n\n  // 增加积分（订单完成后调用）\n  .post(\n    '/points/earn',\n    async ({ body, headers, user }) => {\n      if (!user || !hasPermission(user.role, 'member:write')) {\n        return error('权限不足，需要 member:write', 403)\n      }\n\n      const ip = getClientIp(headers as Record<string, string | undefined>)\n      const rateKey = `${MEMBER_RATE_PREFIX}earn:${user.id || ip}`\n      if (!(await checkRateLimit(rateKey))) {\n        return error('操作过于频繁，请稍后重试', 429)\n      }\n\n      const idempotencyKey = headers['idempotency-key'] as string | undefined\n      const idemKey = idempotencyKey ? `${MEMBER_IDEM_PREFIX}earn:${idempotencyKey}` : undefined\n      const idemResult = await ensureIdempotent(idemKey)\n      if (!idemResult.ok) {\n        return error(idemResult.message || '重复请求', 409)\n      }\n\n      const { userId, amount, orderId, description } = body\n\n      // 计算获得的积分\n      const earnedPoints = Math.floor(amount * POINTS_PER_YUAN)\n\n      if (earnedPoints <= 0) {\n        await finalizeIdempotent(idemResult.redisKey)\n        return success({ earnedPoints: 0 }, '消费金额过低，未获得积分')\n      }\n\n      // 查找或创建会员\n      let [member] = await db.select().from(members).where(eq(members.userId, userId)).limit(1)\n\n      if (!member) {\n        ;[member] = await db\n          .insert(members)\n          .values({\n            userId,\n            level: 1,\n            points: earnedPoints\n          })\n          .returning()\n      } else {\n        ;[member] = await db\n          .update(members)\n          .set({\n            points: sql`${members.points} + ${earnedPoints}`\n          })\n          .where(eq(members.userId, userId))\n          .returning()\n      }\n\n      // 检查是否需要升级\n      if (!member) {\n        await releaseIdempotent(idemResult.redisKey)\n        return error('会员数据异常', 500)\n      }\n\n      const memberRecord = member\n\n      const newLevel = calculateLevel(memberRecord.points)\n      if (newLevel > memberRecord.level) {\n        await db.update(members).set({ level: newLevel }).where(eq(members.userId, userId))\n      }\n\n      await logOperation({\n        adminId: user.id,\n        action: 'points_earn',\n        targetType: 'member',\n        targetId: memberRecord.id,\n        storeId: null,\n        details: { userId, amount, orderId, description, earnedPoints }\n      })\n\n      await finalizeIdempotent(idemResult.redisKey)\n\n      return success(\n        {\n          ...memberRecord,\n          earnedPoints,\n          newLevel: newLevel > memberRecord.level ? newLevel : undefined\n        },\n        `获得 ${earnedPoints} 积分`\n      )\n    },\n    {\n      body: t.Object({\n        userId: t.Number(),\n        amount: t.Number({ minimum: 0 }),\n        orderId: t.Optional(t.Number()),\n        description: t.Optional(t.String())\n      }),\n      detail: { tags: ['Members'], summary: '获得积分' }\n    }\n  )\n\n  // 管理员调整积分\n  .put(\n    '/:id/points',\n    async ({ params, body, user, headers }) => {\n      if (!user || !hasPermission(user.role, 'member:write')) {\n        return error('权限不足，需要 member:write', 403)\n      }\n\n      const ip = getClientIp(headers as Record<string, string | undefined>)\n      const rateKey = `${MEMBER_RATE_PREFIX}adjust:${user.id || ip}`\n      if (!(await checkRateLimit(rateKey))) {\n        return error('操作过于频繁，请稍后重试', 429)\n      }\n\n      const idempotencyKey = headers['idempotency-key'] as string | undefined\n      const idemKey = idempotencyKey ? `${MEMBER_IDEM_PREFIX}adjust:${idempotencyKey}` : undefined\n      const idemResult = await ensureIdempotent(idemKey)\n      if (!idemResult.ok) {\n        return error(idemResult.message || '重复请求', 409)\n      }\n\n      const { points, reason } = body\n\n      const [member] = await db\n        .update(members)\n        .set({\n          points: sql`${members.points} + ${points}`\n        })\n        .where(eq(members.id, params.id))\n        .returning()\n\n      if (!member) {\n        await releaseIdempotent(idemResult.redisKey)\n        return error('会员不存在', 404)\n      }\n\n      await logOperation({\n        adminId: user.id,\n        action: 'points_adjust',\n        targetType: 'member',\n        targetId: params.id,\n        storeId: null,\n        details: { points, reason }\n      })\n\n      await finalizeIdempotent(idemResult.redisKey)\n\n      return success(member, points > 0 ? '积分增加成功' : '积分扣除成功')\n    },\n    {\n      params: t.Object({ id: t.Number() }),\n      body: t.Object({\n        points: t.Number(), // 正数增加，负数扣除\n        reason: t.Optional(t.String())\n      }),\n      detail: { tags: ['Members'], summary: '调整会员积分' }\n    }\n  )\n\n  // 调整会员等级\n  .put(\n    '/:id/level',\n    async ({ params, body, user, headers }) => {\n      if (!user || !hasPermission(user.role, 'member:write')) {\n        return error('权限不足，需要 member:write', 403)\n      }\n\n      const ip = getClientIp(headers as Record<string, string | undefined>)\n      const rateKey = `${MEMBER_RATE_PREFIX}level:${user.id || ip}`\n      if (!(await checkRateLimit(rateKey))) {\n        return error('操作过于频繁，请稍后重试', 429)\n      }\n\n      const [member] = await db\n        .update(members)\n        .set({ level: body.level })\n        .where(eq(members.id, params.id))\n        .returning()\n\n      if (!member) return error('会员不存在', 404)\n\n      await logOperation({\n        adminId: user.id,\n        action: 'level_adjust',\n        targetType: 'member',\n        targetId: params.id,\n        storeId: null,\n        details: { level: body.level }\n      })\n\n      return success(member, '等级调整成功')\n    },\n    {\n      params: t.Object({ id: t.Number() }),\n      body: t.Object({\n        level: t.Number({ minimum: 1, maximum: 10 })\n      }),\n      detail: { tags: ['Members'], summary: '调整会员等级' }\n    }\n  )\n\n  // 获取会员订单历史\n  .get(\n    '/:id/orders',\n    async ({ params, query }) => {\n      const { page, pageSize } = query\n      const { take, skip } = pagination(page, pageSize)\n\n      // 先获取会员的 userId\n      const [member] = await db.select().from(members).where(eq(members.id, params.id)).limit(1)\n\n      if (!member) return error('会员不存在', 404)\n\n      const [orderList, totalResult] = await Promise.all([\n        db\n          .select()\n          .from(orders)\n          .where(eq(orders.userId, member.userId))\n          .orderBy(desc(orders.createdAt))\n          .limit(take)\n          .offset(skip),\n        db.select({ count: count() }).from(orders).where(eq(orders.userId, member.userId))\n      ])\n\n      return success({\n        list: orderList,\n        total: totalResult[0]?.count ?? 0,\n        page: page || 1,\n        pageSize: take\n      })\n    },\n    {\n      params: t.Object({ id: t.Number() }),\n      query: t.Object({\n        page: t.Optional(t.Number()),\n        pageSize: t.Optional(t.Number())\n      }),\n      detail: { tags: ['Members'], summary: '获取会员订单历史' }\n    }\n  )\n\n  // 为用户创建/开通会员\n  .post(\n    '/create',\n    async ({ body, user, headers }) => {\n      if (!user || !hasPermission(user.role, 'member:write')) {\n        return error('权限不足，需要 member:write', 403)\n      }\n\n      const ip = getClientIp(headers as Record<string, string | undefined>)\n      const rateKey = `${MEMBER_RATE_PREFIX}create:${user.id || ip}`\n      if (!(await checkRateLimit(rateKey))) {\n        return error('操作过于频繁，请稍后重试', 429)\n      }\n\n      const idempotencyKey = headers['idempotency-key'] as string | undefined\n      const idemKey = idempotencyKey ? `${MEMBER_IDEM_PREFIX}create:${idempotencyKey}` : undefined\n      const idemResult = await ensureIdempotent(idemKey)\n      if (!idemResult.ok) {\n        return error(idemResult.message || '重复请求', 409)\n      }\n\n      const { userId, level, points } = body\n\n      // 检查用户是否存在\n      const [userRecord] = await db.select().from(users).where(eq(users.id, userId)).limit(1)\n\n      if (!userRecord) {\n        await releaseIdempotent(idemResult.redisKey)\n        return error('用户不存在', 404)\n      }\n\n      // 检查是否已有会员记录\n      const [existingMember] = await db\n        .select()\n        .from(members)\n        .where(eq(members.userId, userId))\n        .limit(1)\n\n      if (existingMember) {\n        await releaseIdempotent(idemResult.redisKey)\n        return error('该用户已是会员', 400)\n      }\n\n      const [member] = await db\n        .insert(members)\n        .values({\n          userId,\n          level: level || 1,\n          points: points || 0\n        })\n        .returning()\n\n      if (!member) {\n        await releaseIdempotent(idemResult.redisKey)\n        return error('会员创建失败', 500)\n      }\n\n      const memberRecord = member\n\n      await logOperation({\n        adminId: user.id,\n        action: 'member_create',\n        targetType: 'member',\n        targetId: memberRecord.id,\n        storeId: null,\n        details: { userId, level: memberRecord.level, points: memberRecord.points }\n      })\n\n      await finalizeIdempotent(idemResult.redisKey)\n\n      return success(memberRecord, '会员创建成功')\n    },\n    {\n      body: t.Object({\n        userId: t.Number(),\n        level: t.Optional(t.Number({ minimum: 1, maximum: 10 })),\n        points: t.Optional(t.Number({ minimum: 0 }))\n      }),\n      detail: { tags: ['Members'], summary: '创建会员' }\n    }\n  )\n\n  // 获取会员等级配置\n  .get(\n    '/levels/config',\n    async () => {\n      return success({\n        levels: [\n          { level: 1, name: '普通会员', minPoints: 0, discount: 1.0 },\n          { level: 2, name: '银卡会员', minPoints: 500, discount: 0.98 },\n          { level: 3, name: '金卡会员', minPoints: 2000, discount: 0.95 },\n          { level: 4, name: '铂金会员', minPoints: 5000, discount: 0.92 },\n          { level: 5, name: '钻石会员', minPoints: 10000, discount: 0.88 }\n        ],\n        pointsRule: {\n          earnRate: POINTS_PER_YUAN,\n          redeemRate: POINTS_TO_YUAN\n        }\n      })\n    },\n    {\n      detail: { tags: ['Members'], summary: '获取会员等级配置' }\n    }\n  )\n\n  // 会员统计数据\n  .get(\n    '/stats',\n    async () => {\n      const [totalMembers] = await db.select({ count: count() }).from(members)\n\n      // 各等级会员数量\n      const levelStats = await Promise.all(\n        [1, 2, 3, 4, 5].map(async (level) => {\n          const [result] = await db\n            .select({ count: count() })\n            .from(members)\n            .where(eq(members.level, level))\n          return { level, count: result?.count ?? 0 }\n        })\n      )\n\n      // 总积分\n      const [pointsStats] = await db\n        .select({\n          totalPoints: sql<number>`COALESCE(SUM(${members.points}), 0)`\n        })\n        .from(members)\n\n      return success({\n        totalMembers: totalMembers?.count ?? 0,\n        levelStats,\n        totalPoints: Number(pointsStats?.totalPoints || 0)\n      })\n    },\n    {\n      detail: { tags: ['Members'], summary: '获取会员统计数据' }\n    }\n  )\n\n// 根据积分计算等级\nfunction calculateLevel(points: number): number {\n  if (points >= 10000) return 5\n  if (points >= 5000) return 4\n  if (points >= 2000) return 3\n  if (points >= 500) return 2\n  return 1\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\mini.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[712,715],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[712,715],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'POINTS_PER_YUAN' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":92,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":92,"endColumn":22},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":196,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":196,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4964,4967],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4964,4967],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":241,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":241,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6139,6142],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6139,6142],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":307,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":307,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8086,8089],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8086,8089],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":353,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":353,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9566,9569],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9566,9569],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":415,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":415,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11487,11490],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11487,11490],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":822,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":822,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[23547,23550],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[23547,23550],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":848,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":848,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24337,24340],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24337,24340],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":862,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":862,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24764,24767],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24764,24767],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":915,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":915,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26369,26372],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26369,26372],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":970,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":970,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28210,28213],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28210,28213],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'updatedOrder' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":1040,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":1040,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":13,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 小程序公共接口 - 无需认证\r\n */\r\nimport { Elysia, t } from 'elysia'\r\nimport { jwt } from '@elysiajs/jwt'\r\nimport { eq, and, asc, desc, count, sql } from 'drizzle-orm'\r\nimport {\r\n  db,\r\n  tables,\r\n  stores,\r\n  categories,\r\n  products,\r\n  banners,\r\n  coupons,\r\n  users,\r\n  members,\r\n  storeMembers,\r\n  userCoupons,\r\n  productVariants,\r\n  pointLogs,\r\n  orders,\r\n  orderItems\r\n} from '../db'\r\nimport { success, error } from '../lib/utils'\r\n\r\nconst jwtSecret = process.env.JWT_SECRET || 'your-super-secret-key-change-in-production'\r\n\r\n// 单独的 JWT 插件，面向小程序用户\r\nconst miniJwt = jwt({\r\n  name: 'miniJwt',\r\n  secret: jwtSecret,\r\n  exp: '30d'\r\n})\r\n\r\nasync function verifyMiniUser(headers: Record<string, string>, miniJwtPlugin: any) {\r\n  const authorization = headers.authorization\r\n  if (!authorization?.startsWith('Bearer ')) return null\r\n  const token = authorization.slice(7)\r\n  try {\r\n    return await miniJwtPlugin.verify(token)\r\n  } catch {\r\n    return null\r\n  }\r\n}\r\n\r\nasync function exchangeJsCode(code: string) {\r\n  const appId = process.env.WX_APP_ID\r\n  const secret = process.env.WX_APP_SECRET\r\n\r\n  // 无配置时使用本地 mock，便于开发调试\r\n  if (!appId || !secret) {\r\n    return {\r\n      openid: `mock_${code}`,\r\n      session_key: `mock_session_${code}`\r\n    }\r\n  }\r\n\r\n  const url = `https://api.weixin.qq.com/sns/jscode2session?appid=${appId}&secret=${secret}&js_code=${code}&grant_type=authorization_code`\r\n  const res = await fetch(url)\r\n  const data = (await res.json()) as {\r\n    openid?: string\r\n    unionid?: string\r\n    session_key?: string\r\n    errcode?: number\r\n    errmsg?: string\r\n  }\r\n  if (data.errcode) {\r\n    throw new Error(data.errmsg || '微信登录失败')\r\n  }\r\n  if (!data.openid) {\r\n    throw new Error('获取 openid 失败')\r\n  }\r\n  return { openid: data.openid, unionid: data.unionid, session_key: data.session_key || '' }\r\n}\r\n\r\nasync function ensureStoreMember(storeId: number, userId: number) {\r\n  const [existing] = await db\r\n    .select()\r\n    .from(storeMembers)\r\n    .where(and(eq(storeMembers.storeId, storeId), eq(storeMembers.userId, userId)))\r\n    .limit(1)\r\n\r\n  if (existing) return existing\r\n\r\n  const [created] = await db\r\n    .insert(storeMembers)\r\n    .values({ storeId, userId, level: 1, points: 0 })\r\n    .returning()\r\n  return created\r\n}\r\n\r\nconst POINTS_PER_YUAN = 1 // 每元积1分\r\nconst POINTS_TO_YUAN = 100 // 100 分抵 1 元\r\nconst MAX_REDEEM_PERCENT = 0.5 // 单笔最多抵 50%\r\n\r\nexport const miniRoutes = new Elysia({ prefix: '/mini' })\r\n  .use(miniJwt)\r\n\r\n  // 小程序登录：换取 openid 并发 JWT\r\n  .post(\r\n    '/auth/login',\r\n    async ({ body, miniJwt }) => {\r\n      const { code, nickname, avatar, phone } = body\r\n      if (!code) {\r\n        return error('code 必填', 400)\r\n      }\r\n\r\n      let session\r\n      try {\r\n        session = await exchangeJsCode(code)\r\n      } catch (err) {\r\n        return error((err as Error).message || '微信登录失败', 500)\r\n      }\r\n\r\n      // 查找或创建用户\r\n      const existing = await db\r\n        .select()\r\n        .from(users)\r\n        .where(eq(users.openid, session.openid))\r\n        .limit(1)\r\n      let user = existing[0]\r\n      if (!user) {\r\n        const inserted = await db\r\n          .insert(users)\r\n          .values({\r\n            openid: session.openid,\r\n            unionid: session.unionid,\r\n            nickname,\r\n            avatar,\r\n            phone\r\n          })\r\n          .returning()\r\n        user = inserted[0]\r\n        if (!user) {\r\n          return error('用户创建失败', 500)\r\n        }\r\n      } else {\r\n        // 轻量更新头像昵称\r\n        await db\r\n          .update(users)\r\n          .set({\r\n            nickname: nickname ?? user.nickname,\r\n            avatar: avatar ?? user.avatar,\r\n            phone: phone ?? user.phone,\r\n            updatedAt: new Date()\r\n          })\r\n          .where(eq(users.id, user.id))\r\n      }\r\n\r\n      // 确保存在全局会员档案\r\n      const existingMember = await db\r\n        .select()\r\n        .from(members)\r\n        .where(eq(members.userId, user.id))\r\n        .limit(1)\r\n      if (existingMember.length === 0) {\r\n        await db.insert(members).values({ userId: user.id }).returning()\r\n      }\r\n\r\n      const token = await miniJwt.sign({\r\n        userId: user.id,\r\n        openid: session.openid\r\n      })\r\n\r\n      return success({\r\n        token,\r\n        user: {\r\n          id: user.id,\r\n          openid: user.openid,\r\n          nickname: nickname || user.nickname,\r\n          avatar: avatar || user.avatar,\r\n          phone: phone || user.phone\r\n        }\r\n      })\r\n    },\r\n    {\r\n      body: t.Object({\r\n        code: t.String(),\r\n        nickname: t.Optional(t.String()),\r\n        avatar: t.Optional(t.String()),\r\n        phone: t.Optional(t.String())\r\n      }),\r\n      detail: { tags: ['Mini'], summary: '小程序登录，返回 token' }\r\n    }\r\n  )\r\n\r\n  // 获取 / 创建当前门店的会员子账户\r\n  .get(\r\n    '/members/me',\r\n    async ({ headers, query, miniJwt }) => {\r\n      const storeId = Number(query.storeId)\r\n      if (!storeId) {\r\n        return error('storeId 必填', 400)\r\n      }\r\n\r\n      const authUser = await verifyMiniUser(headers as any, miniJwt)\r\n      if (!authUser?.userId) {\r\n        return error('未授权，请先登录', 401)\r\n      }\r\n\r\n      const userId = Number(authUser.userId)\r\n\r\n      let [storeMember] = await db\r\n        .select()\r\n        .from(storeMembers)\r\n        .where(and(eq(storeMembers.storeId, storeId), eq(storeMembers.userId, userId)))\r\n        .limit(1)\r\n\r\n      if (!storeMember) {\r\n        ;[storeMember] = await db\r\n          .insert(storeMembers)\r\n          .values({ storeId, userId, level: 1, points: 0 })\r\n          .returning()\r\n      }\r\n\r\n      if (!storeMember) {\r\n        return error('会员信息不存在', 404)\r\n      }\r\n\r\n      return success({\r\n        storeId,\r\n        userId,\r\n        level: storeMember.level,\r\n        points: storeMember.points,\r\n        balance: storeMember.balance\r\n      })\r\n    },\r\n    {\r\n      query: t.Object({ storeId: t.Number() }),\r\n      detail: { tags: ['Mini'], summary: '获取当前门店会员信息' }\r\n    }\r\n  )\r\n\r\n  // 获取积分记录\r\n  .get(\r\n    '/members/points/history',\r\n    async ({ query, headers, miniJwt }) => {\r\n      const storeId = Number(query.storeId)\r\n      if (!storeId) return error('storeId 必填', 400)\r\n\r\n      const authUser = await verifyMiniUser(headers as any, miniJwt)\r\n      if (!authUser?.userId) return error('未授权，请先登录', 401)\r\n\r\n      const userId = Number(authUser.userId)\r\n\r\n      // 获取会员信息\r\n      const [member] = await db\r\n        .select()\r\n        .from(storeMembers)\r\n        .where(and(eq(storeMembers.storeId, storeId), eq(storeMembers.userId, userId)))\r\n        .limit(1)\r\n\r\n      if (!member) {\r\n        return success({ logs: [], currentPoints: 0 })\r\n      }\r\n\r\n      // 获取积分记录\r\n      const logs = await db\r\n        .select({\r\n          id: pointLogs.id,\r\n          change: pointLogs.change,\r\n          reason: pointLogs.reason,\r\n          createdAt: pointLogs.createdAt,\r\n          orderId: pointLogs.orderId,\r\n          orderNo: sql<string>`COALESCE(${orders.orderNo}, '')`.as('orderNo')\r\n        })\r\n        .from(pointLogs)\r\n        .leftJoin(orders, eq(pointLogs.orderId, orders.id))\r\n        .where(and(eq(pointLogs.storeId, storeId), eq(pointLogs.userId, userId)))\r\n        .orderBy(desc(pointLogs.createdAt))\r\n        .limit(100)\r\n\r\n      return success({\r\n        logs: logs.map(\r\n          (log: {\r\n            id: number\r\n            change: number\r\n            reason: string\r\n            createdAt: Date\r\n            orderId: number | null\r\n            orderNo: string | null\r\n          }) => ({\r\n            id: log.id,\r\n            change: log.change,\r\n            reason: log.reason,\r\n            createdAt: log.createdAt,\r\n            orderId: log.orderId,\r\n            orderNo: log.orderNo || undefined\r\n          })\r\n        ),\r\n        currentPoints: member.points\r\n      })\r\n    },\r\n    {\r\n      query: t.Object({ storeId: t.Number() }),\r\n      detail: { tags: ['Mini'], summary: '获取积分记录' }\r\n    }\r\n  )\r\n\r\n  // 可领取优惠券（附带用户领取状态）\r\n  .get(\r\n    '/coupons/available',\r\n    async ({ query, headers, miniJwt }) => {\r\n      const storeId = Number(query.storeId)\r\n      if (!storeId) return error('storeId 必填', 400)\r\n\r\n      const authUser = await verifyMiniUser(headers as any, miniJwt)\r\n      const userId = authUser?.userId as number | undefined\r\n\r\n      const now = new Date()\r\n      const couponList = await db\r\n        .select()\r\n        .from(coupons)\r\n        .where(\r\n          and(\r\n            eq(coupons.storeId, storeId),\r\n            eq(coupons.status, 'ACTIVE'),\r\n            sql`${coupons.startTime} <= ${now}`,\r\n            sql`${coupons.endTime} >= ${now}`\r\n          )\r\n        )\r\n        .orderBy(desc(coupons.createdAt))\r\n\r\n      if (!userId) return success(couponList)\r\n\r\n      const userCouponList = await db\r\n        .select({ couponId: userCoupons.couponId, count: count() })\r\n        .from(userCoupons)\r\n        .where(and(eq(userCoupons.userId, userId), eq(userCoupons.storeId, storeId)))\r\n        .groupBy(userCoupons.couponId)\r\n      const map = new Map(\r\n        userCouponList.map((uc: { couponId: number; count: number }) => [uc.couponId, uc.count])\r\n      )\r\n\r\n      const result = couponList.map((c: typeof coupons.$inferSelect) => {\r\n        const claimed = map.get(c.id) || 0\r\n        return { ...c, claimed, canClaim: claimed < c.perUserLimit }\r\n      })\r\n\r\n      return success(result)\r\n    },\r\n    {\r\n      query: t.Object({ storeId: t.Number() }),\r\n      detail: { tags: ['Mini'], summary: '可领取优惠券（含用户领取状态）' }\r\n    }\r\n  )\r\n\r\n  // 领取优惠券\r\n  .post(\r\n    '/coupons/:id/claim',\r\n    async ({ params, body, headers, miniJwt }) => {\r\n      const { storeId } = body\r\n      const authUser = await verifyMiniUser(headers as any, miniJwt)\r\n      if (!authUser?.userId) return error('未授权，请先登录', 401)\r\n\r\n      const userId = Number(authUser.userId)\r\n      if (!storeId) return error('storeId 必填', 400)\r\n\r\n      const [coupon] = await db.select().from(coupons).where(eq(coupons.id, params.id)).limit(1)\r\n      if (!coupon) return error('优惠券不存在', 404)\r\n      if (coupon.storeId !== storeId) return error('该优惠券不适用于当前门店', 400)\r\n\r\n      const now = new Date()\r\n      if (coupon.status !== 'ACTIVE' || now < coupon.startTime || now > coupon.endTime) {\r\n        return error('优惠券无效或过期', 400)\r\n      }\r\n      if (coupon.totalCount !== -1 && coupon.claimedCount >= coupon.totalCount) {\r\n        return error('优惠券已被领完', 400)\r\n      }\r\n\r\n      const [userClaimed] = await db\r\n        .select({ count: count() })\r\n        .from(userCoupons)\r\n        .where(\r\n          and(\r\n            eq(userCoupons.userId, userId),\r\n            eq(userCoupons.couponId, params.id),\r\n            eq(userCoupons.storeId, storeId)\r\n          )\r\n        )\r\n      if (userClaimed && userClaimed.count >= coupon.perUserLimit) {\r\n        return error('已达领取上限', 400)\r\n      }\r\n\r\n      const [uc] = await db\r\n        .insert(userCoupons)\r\n        .values({\r\n          storeId,\r\n          userId,\r\n          couponId: params.id,\r\n          expireAt: coupon.endTime\r\n        })\r\n        .returning()\r\n\r\n      await db\r\n        .update(coupons)\r\n        .set({ claimedCount: sql`${coupons.claimedCount} + 1` })\r\n        .where(eq(coupons.id, params.id))\r\n\r\n      return success(uc, '领取成功')\r\n    },\r\n    {\r\n      params: t.Object({ id: t.Number() }),\r\n      body: t.Object({ storeId: t.Number() }),\r\n      detail: { tags: ['Mini'], summary: '领取优惠券（小程序端）' }\r\n    }\r\n  )\r\n\r\n  // 小程序下单（含积分抵扣）\r\n  .post(\r\n    '/orders',\r\n    async ({ body, headers, miniJwt }) => {\r\n      const { storeId, tableId, items, remark, usePoints } = body\r\n\r\n      const authUser = await verifyMiniUser(headers as any, miniJwt)\r\n      if (!authUser?.userId) return error('未授权，请先登录', 401)\r\n      const userId = Number(authUser.userId)\r\n\r\n      const [table] = await db.select().from(tables).where(eq(tables.id, tableId)).limit(1)\r\n      if (!table || table.storeId !== storeId) return error('桌台与门店不匹配', 400)\r\n\r\n      let totalAmount = 0\r\n      const orderItemsData: {\r\n        variantId: number\r\n        quantity: number\r\n        price: string\r\n        snapshot: { name: string; categoryName: string; specs: Record<string, string> }\r\n        attributes?: { name: string; value: string }[] | null\r\n      }[] = []\r\n\r\n      for (const item of items) {\r\n        const [variant] = await db\r\n          .select()\r\n          .from(productVariants)\r\n          .leftJoin(products, eq(productVariants.productId, products.id))\r\n          .leftJoin(categories, eq(products.categoryId, categories.id))\r\n          .where(eq(productVariants.id, item.variantId))\r\n          .limit(1)\r\n        if (!variant || !variant.products) return error('商品不存在', 404)\r\n        if (variant.products.storeId !== storeId) return error('商品不属于该门店', 400)\r\n\r\n        const price = Number(variant.product_variants.price)\r\n        totalAmount += price * item.quantity\r\n        orderItemsData.push({\r\n          variantId: item.variantId,\r\n          quantity: item.quantity,\r\n          price: price.toString(),\r\n          snapshot: {\r\n            name: variant.products.name || '',\r\n            categoryName: variant.categories?.name || '',\r\n            specs: variant.product_variants.specs || {}\r\n          },\r\n          attributes: item.attributes || null\r\n        })\r\n      }\r\n\r\n      // 积分抵扣\r\n      let pointsUsed = 0\r\n      let pointsDiscount = 0\r\n      if (usePoints) {\r\n        const storeMember = await ensureStoreMember(storeId, userId)\r\n        const availablePoints = storeMember?.points ?? 0\r\n        const maxDiscountAmount = totalAmount * MAX_REDEEM_PERCENT\r\n        const maxPointsAllow = Math.floor(maxDiscountAmount * POINTS_TO_YUAN)\r\n        pointsUsed = Math.min(usePoints, availablePoints, maxPointsAllow)\r\n        pointsDiscount = pointsUsed / POINTS_TO_YUAN\r\n      }\r\n      const payAmount = Math.max(totalAmount - pointsDiscount, 0)\r\n\r\n      const [order] = await db\r\n        .insert(orders)\r\n        .values({\r\n          orderNo: `MINI-${Date.now()}`,\r\n          storeId,\r\n          tableId,\r\n          userId,\r\n          totalAmount: totalAmount.toString(),\r\n          payAmount: payAmount.toString(),\r\n          pointsUsed,\r\n          pointsDiscount: pointsDiscount.toString(),\r\n          remark\r\n        })\r\n        .returning()\r\n\r\n      if (orderItemsData.length > 0) {\r\n        await db.insert(orderItems).values(\r\n          orderItemsData.map((item) => ({\r\n            orderId: order!.id,\r\n            productVariantId: item.variantId,\r\n            quantity: item.quantity,\r\n            price: item.price,\r\n            snapshot: item.snapshot,\r\n            attributes: item.attributes\r\n          }))\r\n        )\r\n      }\r\n\r\n      if (pointsUsed > 0) {\r\n        await db\r\n          .update(storeMembers)\r\n          .set({ points: sql`${storeMembers.points} - ${pointsUsed}` })\r\n          .where(and(eq(storeMembers.storeId, storeId), eq(storeMembers.userId, userId)))\r\n\r\n        await db.insert(pointLogs).values({\r\n          storeId,\r\n          userId,\r\n          orderId: order!.id,\r\n          change: -pointsUsed,\r\n          reason: 'REDEEM_ORDER',\r\n          meta: { orderNo: order!.orderNo, source: 'mini' }\r\n        })\r\n      }\r\n\r\n      return success(order, '下单成功')\r\n    },\r\n    {\r\n      body: t.Object({\r\n        storeId: t.Number(),\r\n        tableId: t.Number(),\r\n        items: t.Array(\r\n          t.Object({\r\n            variantId: t.Number(),\r\n            quantity: t.Number(),\r\n            attributes: t.Optional(t.Array(t.Object({ name: t.String(), value: t.String() })))\r\n          })\r\n        ),\r\n        remark: t.Optional(t.String()),\r\n        usePoints: t.Optional(t.Number())\r\n      }),\r\n      detail: { tags: ['Mini'], summary: '小程序下单（含积分抵扣）' }\r\n    }\r\n  )\r\n\r\n  // 获取桌台信息（通过二维码）\r\n  .get(\r\n    '/table/:qrCode',\r\n    async ({ params }) => {\r\n      const result = await db\r\n        .select()\r\n        .from(tables)\r\n        .leftJoin(stores, eq(tables.storeId, stores.id))\r\n        .where(eq(tables.qrCode, params.qrCode))\r\n        .limit(1)\r\n\r\n      if (result.length === 0) {\r\n        return error('桌台不存在或二维码无效', 404)\r\n      }\r\n\r\n      const row = result[0]!\r\n      return success({\r\n        table: {\r\n          id: row.tables.id,\r\n          name: row.tables.name,\r\n          capacity: row.tables.capacity,\r\n          status: row.tables.status\r\n        },\r\n        store: row.stores\r\n          ? {\r\n              id: row.stores.id,\r\n              name: row.stores.name,\r\n              logo: row.stores.logo,\r\n              welcomeText: row.stores.welcomeText,\r\n              orderTip: row.stores.orderTip,\r\n              businessHours: row.stores.businessHours\r\n            }\r\n          : null\r\n      })\r\n    },\r\n    {\r\n      params: t.Object({ qrCode: t.String() }),\r\n      detail: { tags: ['Mini'], summary: '通过二维码获取桌台信息' }\r\n    }\r\n  )\r\n  // 获取门店信息\r\n  .get(\r\n    '/store/:id',\r\n    async ({ params }) => {\r\n      const [store] = await db.select().from(stores).where(eq(stores.id, params.id)).limit(1)\r\n\r\n      if (!store) {\r\n        return error('门店不存在', 404)\r\n      }\r\n\r\n      return success({\r\n        id: store.id,\r\n        name: store.name,\r\n        logo: store.logo,\r\n        welcomeText: store.welcomeText,\r\n        orderTip: store.orderTip,\r\n        businessHours: store.businessHours\r\n      })\r\n    },\r\n    {\r\n      params: t.Object({ id: t.Number() }),\r\n      detail: { tags: ['Mini'], summary: '获取门店信息' }\r\n    }\r\n  )\r\n  // 获取分类列表\r\n  .get(\r\n    '/categories',\r\n    async ({ query }) => {\r\n      const storeId = query.storeId\r\n      if (!storeId) {\r\n        return error('storeId 必填', 400)\r\n      }\r\n\r\n      const categoryList = await db\r\n        .select()\r\n        .from(categories)\r\n        .where(and(eq(categories.storeId, storeId), eq(categories.status, 'ACTIVE')))\r\n        .orderBy(asc(categories.sort))\r\n\r\n      return success(categoryList)\r\n    },\r\n    {\r\n      query: t.Object({ storeId: t.Number() }),\r\n      detail: { tags: ['Mini'], summary: '获取分类列表' }\r\n    }\r\n  )\r\n  // 获取商品列表\r\n  .get(\r\n    '/products',\r\n    async ({ query }) => {\r\n      const { storeId, categoryId } = query\r\n      if (!storeId) {\r\n        return error('storeId 必填', 400)\r\n      }\r\n\r\n      const conditions = [eq(products.storeId, storeId), eq(products.status, 'AVAILABLE')]\r\n      if (categoryId) {\r\n        conditions.push(eq(products.categoryId, categoryId))\r\n      }\r\n\r\n      const productList = await db\r\n        .select()\r\n        .from(products)\r\n        .leftJoin(categories, eq(products.categoryId, categories.id))\r\n        .where(and(...conditions))\r\n        .orderBy(asc(products.sort))\r\n\r\n      return success({\r\n        list: productList.map(\r\n          (r: {\r\n            products: typeof products.$inferSelect\r\n            categories: typeof categories.$inferSelect | null\r\n          }) => ({\r\n            id: r.products.id,\r\n            categoryId: r.products.categoryId,\r\n            name: r.products.name,\r\n            description: r.products.description,\r\n            image: r.products.imageUrl,\r\n            price: Number(r.products.basePrice),\r\n            sales: r.products.sales,\r\n            status: r.products.status,\r\n            createdAt: r.products.createdAt,\r\n            category: r.categories ? { id: r.categories.id, name: r.categories.name } : null\r\n          })\r\n        )\r\n      })\r\n    },\r\n    {\r\n      query: t.Object({\r\n        storeId: t.Number(),\r\n        categoryId: t.Optional(t.Number())\r\n      }),\r\n      detail: { tags: ['Mini'], summary: '获取商品列表' }\r\n    }\r\n  )\r\n  // 获取商品详情\r\n  .get(\r\n    '/products/:id',\r\n    async ({ params }) => {\r\n      const [result] = await db\r\n        .select()\r\n        .from(products)\r\n        .leftJoin(categories, eq(products.categoryId, categories.id))\r\n        .where(eq(products.id, params.id))\r\n        .limit(1)\r\n\r\n      if (!result) {\r\n        return error('商品不存在', 404)\r\n      }\r\n\r\n      return success({\r\n        id: result.products.id,\r\n        categoryId: result.products.categoryId,\r\n        name: result.products.name,\r\n        description: result.products.description,\r\n        image: result.products.imageUrl,\r\n        price: Number(result.products.basePrice),\r\n        sales: result.products.sales,\r\n        status: result.products.status,\r\n        createdAt: result.products.createdAt,\r\n        category: result.categories\r\n          ? { id: result.categories.id, name: result.categories.name }\r\n          : null\r\n      })\r\n    },\r\n    {\r\n      params: t.Object({ id: t.Number() }),\r\n      detail: { tags: ['Mini'], summary: '获取商品详情' }\r\n    }\r\n  )\r\n  // 获取轮播图\r\n  .get(\r\n    '/banners',\r\n    async ({ query }) => {\r\n      const storeId = query.storeId\r\n      if (!storeId) {\r\n        return error('storeId 必填', 400)\r\n      }\r\n\r\n      const bannerList = await db\r\n        .select()\r\n        .from(banners)\r\n        .where(and(eq(banners.storeId, storeId), eq(banners.isActive, true)))\r\n        .orderBy(asc(banners.sort))\r\n\r\n      return success(bannerList)\r\n    },\r\n    {\r\n      query: t.Object({ storeId: t.Number() }),\r\n      detail: { tags: ['Mini'], summary: '获取轮播图列表' }\r\n    }\r\n  )\r\n  // 获取可领取优惠券\r\n  .get(\r\n    '/coupons',\r\n    async ({ query }) => {\r\n      const storeId = query.storeId\r\n      if (!storeId) {\r\n        return error('storeId 必填', 400)\r\n      }\r\n\r\n      const now = new Date()\r\n      const couponList = await db.select().from(coupons).where(eq(coupons.storeId, storeId))\r\n\r\n      // 过滤有效的优惠券\r\n      const validCoupons = couponList.filter((c: typeof coupons.$inferSelect) => {\r\n        if (c.status !== 'ACTIVE') return false\r\n        if (c.startTime && new Date(c.startTime) > now) return false\r\n        if (c.endTime && new Date(c.endTime) < now) return false\r\n        if (c.totalCount !== null && c.usedCount >= c.totalCount) return false\r\n        return true\r\n      })\r\n\r\n      return success(\r\n        validCoupons.map((c) => ({\r\n          id: c.id,\r\n          name: c.name,\r\n          type: c.type,\r\n          value: Number(c.value),\r\n          minAmount: Number(c.minAmount),\r\n          startTime: c.startTime,\r\n          endTime: c.endTime\r\n        }))\r\n      )\r\n    },\r\n    {\r\n      query: t.Object({ storeId: t.Number() }),\r\n      detail: { tags: ['Mini'], summary: '获取可领取优惠券' }\r\n    }\r\n  )\r\n\r\n  // 通过 ID 获取桌台信息\r\n  .get(\r\n    '/tables/:id',\r\n    async ({ params, query }) => {\r\n      const storeId = query.storeId\r\n\r\n      const result = await db\r\n        .select()\r\n        .from(tables)\r\n        .leftJoin(stores, eq(tables.storeId, stores.id))\r\n        .where(eq(tables.id, params.id))\r\n        .limit(1)\r\n\r\n      if (result.length === 0) {\r\n        return error('桌台不存在', 404)\r\n      }\r\n\r\n      const row = result[0]!\r\n\r\n      // 如果指定了 storeId，验证桌台属于该门店\r\n      if (storeId && row.tables.storeId !== storeId) {\r\n        return error('桌台不属于该门店', 400)\r\n      }\r\n\r\n      return success({\r\n        table: {\r\n          id: row.tables.id,\r\n          name: row.tables.name,\r\n          capacity: row.tables.capacity,\r\n          status: row.tables.status,\r\n          storeId: row.tables.storeId\r\n        },\r\n        store: row.stores\r\n          ? {\r\n              id: row.stores.id,\r\n              name: row.stores.name,\r\n              logo: row.stores.logo,\r\n              welcomeText: row.stores.welcomeText,\r\n              orderTip: row.stores.orderTip,\r\n              businessHours: row.stores.businessHours\r\n            }\r\n          : null\r\n      })\r\n    },\r\n    {\r\n      params: t.Object({ id: t.Number() }),\r\n      query: t.Object({ storeId: t.Optional(t.Number()) }),\r\n      detail: { tags: ['Mini'], summary: '通过 ID 获取桌台信息' }\r\n    }\r\n  )\r\n\r\n  // 获取用户订单列表\r\n  .get(\r\n    '/orders',\r\n    async ({ headers, query, miniJwt }) => {\r\n      const { storeId, tableId, page = 1, pageSize = 20 } = query\r\n\r\n      const authUser = await verifyMiniUser(headers as any, miniJwt)\r\n      if (!authUser?.userId) {\r\n        return error('未授权，请先登录', 401)\r\n      }\r\n\r\n      const conditions = [eq(orders.userId, Number(authUser.userId))]\r\n\r\n      if (storeId) {\r\n        conditions.push(eq(orders.storeId, storeId))\r\n      }\r\n      if (tableId) {\r\n        conditions.push(eq(orders.tableId, tableId))\r\n      }\r\n\r\n      const orderList = await db\r\n        .select()\r\n        .from(orders)\r\n        .leftJoin(tables, eq(orders.tableId, tables.id))\r\n        .leftJoin(stores, eq(orders.storeId, stores.id))\r\n        .where(and(...conditions))\r\n        .orderBy(desc(orders.createdAt))\r\n        .limit(pageSize)\r\n        .offset((page - 1) * pageSize)\r\n\r\n      // 获取订单商品\r\n      const orderIds = orderList.map((o) => o.orders.id)\r\n      let itemsMap: Record<number, any[]> = {}\r\n\r\n      if (orderIds.length > 0) {\r\n        const items = await db\r\n          .select()\r\n          .from(orderItems)\r\n          .where(sql`${orderItems.orderId} IN ${orderIds}`)\r\n\r\n        itemsMap = items.reduce(\r\n          (acc, item) => {\r\n            if (!acc[item.orderId]) acc[item.orderId] = []\r\n            acc[item.orderId].push(item)\r\n            return acc\r\n          },\r\n          {} as Record<number, any[]>\r\n        )\r\n      }\r\n\r\n      const result = orderList.map((row) => ({\r\n        id: row.orders.id,\r\n        orderNo: row.orders.orderNo,\r\n        status: row.orders.status,\r\n        totalAmount: Number(row.orders.totalAmount),\r\n        payAmount: Number(row.orders.payAmount),\r\n        pointsUsed: row.orders.pointsUsed,\r\n        pointsDiscount: Number(row.orders.pointsDiscount),\r\n        remark: row.orders.remark,\r\n        createdAt: row.orders.createdAt,\r\n        table: row.tables ? { id: row.tables.id, name: row.tables.name } : null,\r\n        store: row.stores ? { id: row.stores.id, name: row.stores.name } : null,\r\n        items: (itemsMap[row.orders.id] || []).map((item) => ({\r\n          id: item.id,\r\n          quantity: item.quantity,\r\n          price: Number(item.price),\r\n          snapshot: item.snapshot,\r\n          attributes: item.attributes\r\n        }))\r\n      }))\r\n\r\n      // 获取总数\r\n      const [countResult] = await db\r\n        .select({ count: count() })\r\n        .from(orders)\r\n        .where(and(...conditions))\r\n\r\n      return success({\r\n        list: result,\r\n        total: countResult?.count || 0,\r\n        page,\r\n        pageSize\r\n      })\r\n    },\r\n    {\r\n      query: t.Object({\r\n        storeId: t.Optional(t.Number()),\r\n        tableId: t.Optional(t.Number()),\r\n        page: t.Optional(t.Number()),\r\n        pageSize: t.Optional(t.Number())\r\n      }),\r\n      detail: { tags: ['Mini'], summary: '获取用户订单列表' }\r\n    }\r\n  )\r\n\r\n  // 获取订单详情\r\n  .get(\r\n    '/orders/:id',\r\n    async ({ headers, params, miniJwt }) => {\r\n      const authUser = await verifyMiniUser(headers as any, miniJwt)\r\n      if (!authUser?.userId) {\r\n        return error('未授权，请先登录', 401)\r\n      }\r\n\r\n      const [order] = await db\r\n        .select()\r\n        .from(orders)\r\n        .leftJoin(tables, eq(orders.tableId, tables.id))\r\n        .leftJoin(stores, eq(orders.storeId, stores.id))\r\n        .where(and(eq(orders.id, params.id), eq(orders.userId, Number(authUser.userId))))\r\n        .limit(1)\r\n\r\n      if (!order) {\r\n        return error('订单不存在', 404)\r\n      }\r\n\r\n      // 获取订单商品\r\n      const items = await db.select().from(orderItems).where(eq(orderItems.orderId, params.id))\r\n\r\n      return success({\r\n        id: order.orders.id,\r\n        orderNo: order.orders.orderNo,\r\n        status: order.orders.status,\r\n        totalAmount: Number(order.orders.totalAmount),\r\n        payAmount: Number(order.orders.payAmount),\r\n        pointsUsed: order.orders.pointsUsed,\r\n        pointsDiscount: Number(order.orders.pointsDiscount),\r\n        remark: order.orders.remark,\r\n        createdAt: order.orders.createdAt,\r\n        paidAt: order.orders.paidAt,\r\n        completedAt: order.orders.completedAt,\r\n        table: order.tables ? { id: order.tables.id, name: order.tables.name } : null,\r\n        store: order.stores\r\n          ? { id: order.stores.id, name: order.stores.name, logo: order.stores.logo }\r\n          : null,\r\n        items: items.map((item) => ({\r\n          id: item.id,\r\n          quantity: item.quantity,\r\n          price: Number(item.price),\r\n          snapshot: item.snapshot,\r\n          attributes: item.attributes\r\n        }))\r\n      })\r\n    },\r\n    {\r\n      params: t.Object({ id: t.Number() }),\r\n      detail: { tags: ['Mini'], summary: '获取订单详情' }\r\n    }\r\n  )\r\n\r\n  // 加菜\r\n  .post(\r\n    '/orders/:id/add-items',\r\n    async ({ headers, params, body, miniJwt }) => {\r\n      const authUser = await verifyMiniUser(headers as any, miniJwt)\r\n      if (!authUser?.userId) {\r\n        return error('未授权，请先登录', 401)\r\n      }\r\n\r\n      const [order] = await db\r\n        .select()\r\n        .from(orders)\r\n        .where(and(eq(orders.id, params.id), eq(orders.userId, Number(authUser.userId))))\r\n        .limit(1)\r\n\r\n      if (!order) {\r\n        return error('订单不存在', 404)\r\n      }\r\n\r\n      // 只允许在特定状态下加菜\r\n      if (!['PENDING', 'CONFIRMED', 'PREPARING'].includes(order.status)) {\r\n        return error('当前订单状态不允许加菜', 400)\r\n      }\r\n\r\n      const { items } = body\r\n      let addedAmount = 0\r\n      const newItems: {\r\n        orderId: number\r\n        productVariantId: number\r\n        quantity: number\r\n        price: string\r\n        snapshot: { name: string; categoryName: string; specs: Record<string, string> }\r\n        attributes?: { name: string; value: string }[] | null\r\n      }[] = []\r\n\r\n      for (const item of items) {\r\n        const [variant] = await db\r\n          .select()\r\n          .from(productVariants)\r\n          .leftJoin(products, eq(productVariants.productId, products.id))\r\n          .leftJoin(categories, eq(products.categoryId, categories.id))\r\n          .where(eq(productVariants.id, item.variantId))\r\n          .limit(1)\r\n\r\n        if (!variant || !variant.products) {\r\n          return error(`商品不存在: ${item.variantId}`, 404)\r\n        }\r\n\r\n        const price = Number(variant.product_variants.price)\r\n        addedAmount += price * item.quantity\r\n\r\n        newItems.push({\r\n          orderId: order.id,\r\n          productVariantId: item.variantId,\r\n          quantity: item.quantity,\r\n          price: price.toString(),\r\n          snapshot: {\r\n            name: variant.products.name || '',\r\n            categoryName: variant.categories?.name || '',\r\n            specs: variant.product_variants.specs || {}\r\n          },\r\n          attributes: item.attributes || null\r\n        })\r\n      }\r\n\r\n      // 插入新的订单项\r\n      if (newItems.length > 0) {\r\n        await db.insert(orderItems).values(newItems)\r\n      }\r\n\r\n      // 更新订单金额\r\n      const newTotalAmount = Number(order.totalAmount) + addedAmount\r\n      const newPayAmount = Number(order.payAmount) + addedAmount\r\n\r\n      const [updatedOrder] = await db\r\n        .update(orders)\r\n        .set({\r\n          totalAmount: newTotalAmount.toString(),\r\n          payAmount: newPayAmount.toString(),\r\n          updatedAt: new Date()\r\n        })\r\n        .where(eq(orders.id, order.id))\r\n        .returning()\r\n\r\n      return success(\r\n        {\r\n          orderId: order.id,\r\n          addedItems: newItems.length,\r\n          addedAmount,\r\n          newTotalAmount,\r\n          newPayAmount\r\n        },\r\n        '加菜成功'\r\n      )\r\n    },\r\n    {\r\n      params: t.Object({ id: t.Number() }),\r\n      body: t.Object({\r\n        items: t.Array(\r\n          t.Object({\r\n            variantId: t.Number(),\r\n            quantity: t.Number(),\r\n            attributes: t.Optional(t.Array(t.Object({ name: t.String(), value: t.String() })))\r\n          })\r\n        )\r\n      }),\r\n      detail: { tags: ['Mini'], summary: '加菜' }\r\n    }\r\n  )\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\orders.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\page-configs.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'requireAuth' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":40}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Elysia, t } from 'elysia'\nimport { db, pageConfigs, type PageComponent } from '../db'\nimport { eq, and } from 'drizzle-orm'\nimport { requirePermission, requireAuth } from '../lib/auth'\n\n// 页面类型定义（10个Tab）\nconst PAGE_TYPES = [\n  { value: 'HOME', label: '首页' },\n  { value: 'MENU', label: '点餐页' },\n  { value: 'PRODUCT_DETAIL', label: '商品详情页' },\n  { value: 'ORDER_CENTER', label: '订单中心' },\n  { value: 'PROFILE', label: '个人中心' },\n  { value: 'MEMBER', label: '会员页' },\n  { value: 'BARRAGE', label: '用户下单弹幕' },\n  { value: 'TABBAR', label: '底部导航设计' },\n  { value: 'TOPIC', label: '专题页面' },\n  { value: 'RECHARGE', label: '充值页面' }\n] as const\n\n// 组件类型定义（完整40+组件）\nconst COMPONENT_TYPES = [\n  // 极简组件 (8个)\n  { value: 'FOCUS_ENTRY', label: '焦点入口', icon: 'Zap', category: 'simple' },\n  { value: 'STAMP_CARD', label: '集章/集点卡', icon: 'Star', category: 'simple' },\n  { value: 'COUPON_ENTRY', label: '领取优惠券', icon: 'Ticket', category: 'simple' },\n  { value: 'BALANCE_ENTRY', label: '储值余额', icon: 'Wallet', category: 'simple' },\n  { value: 'FLOAT_WINDOW', label: '悬浮窗口', icon: 'Square', category: 'simple' },\n  { value: 'POINTS_ENTRY', label: '会员积分', icon: 'Award', category: 'simple' },\n  { value: 'SERVICE_ENTRY', label: '客服入口', icon: 'MessageCircle', category: 'simple' },\n  { value: 'NEARBY_STORES', label: '附近门店', icon: 'MapPin', category: 'simple' },\n  // 标准组件 (17个)\n  { value: 'BANNER', label: '轮播图', icon: 'Image', category: 'standard' },\n  { value: 'NAV_GRID', label: '导航', icon: 'LayoutGrid', category: 'standard' },\n  { value: 'STORE_LIST', label: '门店列表', icon: 'Store', category: 'standard' },\n  { value: 'PRODUCT_LIST', label: '商品列表', icon: 'List', category: 'standard' },\n  { value: 'PRODUCT_GRID', label: '商品网格', icon: 'LayoutGrid', category: 'standard' },\n  { value: 'PROMOTION', label: '营销模块', icon: 'Gift', category: 'standard' },\n  { value: 'STAMP_CARD_STD', label: '集点卡', icon: 'Star', category: 'standard' },\n  { value: 'WECHAT_OA', label: '公众号组件', icon: 'Hash', category: 'standard' },\n  { value: 'COMBO_PROMO', label: '套餐推广', icon: 'Package', category: 'standard' },\n  { value: 'SEARCH', label: '搜索模块', icon: 'Search', category: 'standard' },\n  { value: 'STORE_TITLE', label: '门店标题', icon: 'Store', category: 'standard' },\n  { value: 'CART_FLOAT', label: '购物车', icon: 'ShoppingCart', category: 'standard' },\n  { value: 'NOTICE', label: '公告栏', icon: 'Bell', category: 'standard' },\n  { value: 'HOT_PRODUCTS', label: '热销商品', icon: 'Flame', category: 'standard' },\n  { value: 'NEW_PRODUCTS', label: '新品推荐', icon: 'Sparkles', category: 'standard' },\n  { value: 'COUPON', label: '优惠券', icon: 'Ticket', category: 'standard' },\n  { value: 'SPACER', label: '分隔符', icon: 'Minus', category: 'standard' },\n  // 自由容器 (2个)\n  { value: 'FREE_CONTAINER', label: '自由容器', icon: 'Box', category: 'container' },\n  { value: 'FLOAT_CONTAINER', label: '悬浮容器', icon: 'Layers', category: 'container' },\n  // 基础元素 (12个)\n  { value: 'IMAGE', label: '图片', icon: 'ImagePlus', category: 'element' },\n  { value: 'TEXT', label: '文本', icon: 'Type', category: 'element' },\n  { value: 'USER_NICKNAME', label: '昵称', icon: 'User', category: 'element' },\n  { value: 'USER_AVATAR', label: '头像', icon: 'Circle', category: 'element' },\n  { value: 'USER_PHONE', label: '手机号', icon: 'Phone', category: 'element' },\n  { value: 'USER_POINTS', label: '积分', icon: 'Award', category: 'element' },\n  { value: 'USER_BALANCE', label: '余额', icon: 'Wallet', category: 'element' },\n  { value: 'COUPON_COUNT', label: '可用券数量', icon: 'Ticket', category: 'element' },\n  { value: 'STORE_NAME', label: '门店名称', icon: 'Store', category: 'element' },\n  { value: 'STORE_DISTANCE', label: '门店距离', icon: 'MapPin', category: 'element' },\n  { value: 'MEMBER_BADGE', label: '会员标识', icon: 'Crown', category: 'element' },\n  { value: 'MEMBER_PROGRESS', label: '会员进度', icon: 'BarChart', category: 'element' },\n  // 专属组件 (7个)\n  {\n    value: 'ORDER_COMPONENT',\n    label: '点单组件',\n    icon: 'ShoppingCart',\n    category: 'special',\n    availableIn: ['MENU']\n  },\n  {\n    value: 'USER_INFO',\n    label: '会员信息',\n    icon: 'User',\n    category: 'special',\n    availableIn: ['PROFILE']\n  },\n  {\n    value: 'FUNC_ENTRY',\n    label: '功能入口',\n    icon: 'LayoutGrid',\n    category: 'special',\n    availableIn: ['PROFILE']\n  },\n  {\n    value: 'MEMBER_RIGHTS',\n    label: '会员权益',\n    icon: 'Award',\n    category: 'special',\n    availableIn: ['MEMBER']\n  },\n  {\n    value: 'MEMBER_LEVEL',\n    label: '会员等级',\n    icon: 'Crown',\n    category: 'special',\n    availableIn: ['MEMBER']\n  },\n  {\n    value: 'RECHARGE_OPTIONS',\n    label: '充值选项',\n    icon: 'CreditCard',\n    category: 'special',\n    availableIn: ['RECHARGE']\n  },\n  {\n    value: 'RECHARGE_BUTTON',\n    label: '充值按钮',\n    icon: 'Wallet',\n    category: 'special',\n    availableIn: ['RECHARGE']\n  }\n] as const\n\n// 精美的酒馆主题预设首页模板\n// 精心设计的布局：合理的间距、视觉层次、对齐和留白\n// 总高度：180 + 40 + 16 + 40 + 16 + 100 + 16 + 60 + 16 + 192 = 676px（超出612px，需要调整）\n// 优化后：180 + 40 + 12 + 40 + 12 + 100 + 12 + 60 + 12 + 180 = 648px（超出，继续优化）\n// 最终：180 + 40 + 8 + 40 + 8 + 100 + 8 + 60 + 8 + 180 = 632px（超出20px，需要压缩）\n// 最终优化：180 + 40 + 8 + 40 + 8 + 90 + 8 + 56 + 8 + 174 = 612px ✓\nconst DEFAULT_HOME_COMPONENTS: PageComponent[] = [\n  // 1. 轮播图 - 全宽，顶部\n  {\n    id: 'preset-banner-1',\n    type: 'BANNER',\n    title: '轮播图',\n    visible: true,\n    x: 0,\n    y: 0,\n    width: 375,\n    height: 180,\n    zIndex: 1,\n    props: {\n      autoplay: true,\n      interval: 3000,\n      height: 180,\n      showIndicator: true,\n      indicatorStyle: 'dot',\n      indicatorPosition: 'center',\n      indicatorColor: 'white'\n    }\n  },\n  // 2. 公告栏 - 全宽，紧贴轮播图\n  {\n    id: 'preset-notice-1',\n    type: 'NOTICE',\n    title: '公告栏',\n    visible: true,\n    x: 0,\n    y: 180,\n    width: 375,\n    height: 40,\n    zIndex: 2,\n    props: {\n      scrollable: true,\n      speed: 50,\n      bgColor: '#2c1810',\n      textColor: '#d4a574'\n    }\n  },\n  // 3. 搜索模块 - 左右留白16px，顶部间距8px\n  {\n    id: 'preset-search-1',\n    type: 'SEARCH',\n    title: '搜索模块',\n    visible: true,\n    x: 16,\n    y: 228, // 180 + 40 + 8\n    width: 343, // 375 - 16*2\n    height: 40,\n    zIndex: 3,\n    props: {\n      placeholder: '搜索酒品、小食...',\n      bgColor: '#f5f3f0'\n    }\n  },\n  // 4. 快捷导航 - 左右留白16px，顶部间距8px\n  {\n    id: 'preset-nav-1',\n    type: 'NAV_GRID',\n    title: '快捷导航',\n    visible: true,\n    x: 16,\n    y: 276, // 228 + 40 + 8\n    width: 343,\n    height: 90, // 从100压缩到90\n    zIndex: 4,\n    props: {\n      columns: 4,\n      items: [\n        { icon: '🍺', text: '精酿', link: { type: 'category', value: '' } },\n        { icon: '🥃', text: '威士忌', link: { type: 'category', value: '' } },\n        { icon: '🍸', text: '鸡尾酒', link: { type: 'category', value: '' } },\n        { icon: '🍖', text: '小食', link: { type: 'category', value: '' } }\n      ]\n    }\n  },\n  // 5. 焦点入口 - 左右留白16px，顶部间距8px\n  {\n    id: 'preset-focus-1',\n    type: 'FOCUS_ENTRY',\n    title: '焦点入口',\n    visible: true,\n    x: 16,\n    y: 374, // 276 + 90 + 8\n    width: 343,\n    height: 56, // 从60压缩到56\n    zIndex: 5,\n    props: {\n      icon: '🍻',\n      text: '立即点单',\n      bgColor: '#8B4513',\n      link: { type: 'page', value: '/pages/menu/menu' }\n    }\n  },\n  // 6. 热销推荐 - 左右留白16px，顶部间距8px\n  {\n    id: 'preset-hot-1',\n    type: 'HOT_PRODUCTS',\n    title: '热销推荐',\n    visible: true,\n    x: 16,\n    y: 438, // 374 + 56 + 8\n    width: 343,\n    height: 174, // 从192压缩到174，确保总高度612px\n    zIndex: 6,\n    props: {\n      limit: 6,\n      showRank: true,\n      title: '🍺 人气推荐'\n    }\n  }\n]\n\n// 精美的酒馆主题预设点餐页模板\n// 所有组件宽度统一为 375px，垂直排列，确保不超出 TabBar 区域（612px 高度）\nconst DEFAULT_MENU_COMPONENTS: PageComponent[] = [\n  {\n    id: 'preset-menu-banner-1',\n    type: 'BANNER',\n    title: '轮播图',\n    visible: true,\n    x: 0,\n    y: 0,\n    width: 375,\n    height: 180,\n    zIndex: 1,\n    props: {\n      autoplay: true,\n      interval: 3000,\n      height: 180,\n      showIndicator: true,\n      indicatorStyle: 'dot',\n      indicatorPosition: 'center',\n      indicatorColor: 'white'\n    }\n  },\n  {\n    id: 'preset-menu-notice-1',\n    type: 'NOTICE',\n    title: '公告栏',\n    visible: true,\n    x: 0,\n    y: 180,\n    width: 375,\n    height: 40,\n    zIndex: 2,\n    props: {\n      scrollable: true,\n      speed: 50,\n      bgColor: '#2c1810',\n      textColor: '#d4a574'\n    }\n  },\n  {\n    id: 'preset-menu-order-1',\n    type: 'ORDER_COMPONENT',\n    title: '点单组件',\n    visible: true,\n    x: 0,\n    y: 220,\n    width: 375,\n    height: 392, // 612 - 220 = 392，确保不超出 TabBar 区域\n    zIndex: 3,\n    props: {\n      categoryStyle: 'left',\n      productStyle: 'large',\n      showSales: true,\n      showStock: false,\n      showDesc: true,\n      showCart: true\n    }\n  }\n]\n\n// 公开接口 (小程序用)\nconst publicRoutes = new Elysia().get(\n  '/published',\n  async ({ query }) => {\n    const { storeId } = query\n    const pageType = query.pageType || 'HOME'\n\n    if (!storeId) {\n      return { code: 400, message: 'storeId 必填' }\n    }\n\n    const config = await db\n      .select()\n      .from(pageConfigs)\n      .where(\n        and(\n          eq(pageConfigs.storeId, Number(storeId)),\n          eq(pageConfigs.pageType, pageType),\n          eq(pageConfigs.isPublished, true)\n        )\n      )\n      .limit(1)\n\n    const found = config[0]\n    if (!found) {\n      // 返回预设的精美布局（根据页面类型）\n      const presetComponents =\n        pageType === 'MENU' ? DEFAULT_MENU_COMPONENTS : DEFAULT_HOME_COMPONENTS\n      return {\n        code: 200,\n        data: {\n          pageType,\n          components: presetComponents,\n          isDefault: true\n        }\n      }\n    }\n\n    return {\n      code: 200,\n      data: {\n        pageType: found.pageType,\n        components: found.components,\n        publishedAt: found.publishedAt,\n        isDefault: false\n      }\n    }\n  },\n  {\n    query: t.Object({\n      storeId: t.String(),\n      pageType: t.Optional(t.String())\n    })\n  }\n)\n\n// 管理端接口 (需要认证)\nconst adminRoutes = new Elysia()\n  .use(requirePermission('store:write'))\n\n  // 获取组件类型列表\n  .get('/component-types', () => {\n    return { code: 200, data: COMPONENT_TYPES }\n  })\n\n  // 获取默认模板\n  .get('/templates', () => {\n    return {\n      code: 200,\n      data: [\n        {\n          name: '精美首页',\n          pageType: 'HOME',\n          components: DEFAULT_HOME_COMPONENTS\n        },\n        {\n          name: '精美点餐页',\n          pageType: 'MENU',\n          components: DEFAULT_MENU_COMPONENTS\n        }\n      ]\n    }\n  })\n\n  // 获取门店的页面配置\n  .get(\n    '/',\n    async ({ query, user }) => {\n      const { storeId } = query\n      const pageType = query.pageType || 'HOME'\n\n      const targetStoreId = storeId ? Number(storeId) : user?.storeId\n      if (!targetStoreId) {\n        return { code: 400, message: 'storeId 必填' }\n      }\n\n      const config = await db\n        .select()\n        .from(pageConfigs)\n        .where(and(eq(pageConfigs.storeId, targetStoreId), eq(pageConfigs.pageType, pageType)))\n        .limit(1)\n\n      if (config.length === 0) {\n        // 返回预设的精美布局（根据页面类型）\n        const presetComponents =\n          pageType === 'MENU' ? DEFAULT_MENU_COMPONENTS : DEFAULT_HOME_COMPONENTS\n        return {\n          code: 200,\n          data: {\n            id: null,\n            storeId: targetStoreId,\n            pageType,\n            components: presetComponents,\n            isPublished: false,\n            publishedAt: null,\n            isDefault: true\n          }\n        }\n      }\n\n      return { code: 200, data: { ...config[0], isDefault: false } }\n    },\n    {\n      query: t.Object({\n        storeId: t.Optional(t.String()),\n        pageType: t.Optional(t.String())\n      })\n    }\n  )\n\n  // 保存页面配置（草稿）\n  .put(\n    '/',\n    async ({ body, user }) => {\n      const { storeId, components } = body\n      const pageType = body.pageType || 'HOME'\n\n      const targetStoreId = storeId ?? user?.storeId\n      if (!targetStoreId) {\n        return { code: 400, message: 'storeId 必填' }\n      }\n\n      // 查找现有配置\n      const existing = await db\n        .select()\n        .from(pageConfigs)\n        .where(and(eq(pageConfigs.storeId, targetStoreId), eq(pageConfigs.pageType, pageType)))\n        .limit(1)\n\n      let result\n      const existingConfig = existing[0]\n      if (existingConfig) {\n        // 更新\n        ;[result] = await db\n          .update(pageConfigs)\n          .set({\n            components,\n            updatedAt: new Date()\n          })\n          .where(eq(pageConfigs.id, existingConfig.id))\n          .returning()\n      } else {\n        // 新建\n        ;[result] = await db\n          .insert(pageConfigs)\n          .values({\n            storeId: targetStoreId,\n            pageType,\n            components,\n            isPublished: false\n          })\n          .returning()\n      }\n\n      return { code: 200, data: result, message: '保存成功' }\n    },\n    {\n      body: t.Object({\n        storeId: t.Optional(t.Number()),\n        pageType: t.Optional(t.String()),\n        components: t.Array(\n          t.Object({\n            id: t.String(),\n            type: t.String(),\n            title: t.Optional(t.String()),\n            visible: t.Boolean(),\n            props: t.Record(t.String(), t.Unknown())\n          })\n        )\n      })\n    }\n  )\n\n  // 发布页面配置\n  .post(\n    '/publish',\n    async ({ body, user }) => {\n      const { storeId } = body\n      const pageType = body.pageType || 'HOME'\n\n      const targetStoreId = storeId ?? user?.storeId\n      if (!targetStoreId) {\n        return { code: 400, message: 'storeId 必填' }\n      }\n\n      const existing = await db\n        .select()\n        .from(pageConfigs)\n        .where(and(eq(pageConfigs.storeId, targetStoreId), eq(pageConfigs.pageType, pageType)))\n        .limit(1)\n\n      const existingConfig = existing[0]\n      if (!existingConfig) {\n        return { code: 404, message: '请先保存配置' }\n      }\n\n      const [result] = await db\n        .update(pageConfigs)\n        .set({\n          isPublished: true,\n          publishedAt: new Date(),\n          updatedAt: new Date()\n        })\n        .where(eq(pageConfigs.id, existingConfig.id))\n        .returning()\n\n      return { code: 200, data: result, message: '发布成功' }\n    },\n    {\n      body: t.Object({\n        storeId: t.Optional(t.Number()),\n        pageType: t.Optional(t.String())\n      })\n    }\n  )\n\n  // 撤销发布\n  .post(\n    '/unpublish',\n    async ({ body, user }) => {\n      const { storeId } = body\n      const pageType = body.pageType || 'HOME'\n\n      const targetStoreId = storeId ?? user?.storeId\n      if (!targetStoreId) {\n        return { code: 400, message: 'storeId 必填' }\n      }\n\n      const existing = await db\n        .select()\n        .from(pageConfigs)\n        .where(and(eq(pageConfigs.storeId, targetStoreId), eq(pageConfigs.pageType, pageType)))\n        .limit(1)\n\n      const existingConfig = existing[0]\n      if (!existingConfig) {\n        return { code: 404, message: '配置不存在' }\n      }\n\n      const [result] = await db\n        .update(pageConfigs)\n        .set({\n          isPublished: false,\n          updatedAt: new Date()\n        })\n        .where(eq(pageConfigs.id, existingConfig.id))\n        .returning()\n\n      return { code: 200, data: result, message: '已撤销发布' }\n    },\n    {\n      body: t.Object({\n        storeId: t.Optional(t.Number()),\n        pageType: t.Optional(t.String())\n      })\n    }\n  )\n\n  // 重置为默认配置\n  .post(\n    '/reset',\n    async ({ body, user }) => {\n      const { storeId } = body\n      const pageType = body.pageType || 'HOME'\n\n      const targetStoreId = storeId ?? user?.storeId\n      if (!targetStoreId) {\n        return { code: 400, message: 'storeId 必填' }\n      }\n\n      const existing = await db\n        .select()\n        .from(pageConfigs)\n        .where(and(eq(pageConfigs.storeId, targetStoreId), eq(pageConfigs.pageType, pageType)))\n        .limit(1)\n\n      const existingConfig = existing[0]\n      const presetComponents =\n        pageType === 'MENU' ? DEFAULT_MENU_COMPONENTS : DEFAULT_HOME_COMPONENTS\n\n      if (existingConfig) {\n        const [result] = await db\n          .update(pageConfigs)\n          .set({\n            components: presetComponents,\n            isPublished: false,\n            updatedAt: new Date()\n          })\n          .where(eq(pageConfigs.id, existingConfig.id))\n          .returning()\n\n        return { code: 200, data: result, message: '已重置为预设配置' }\n      }\n\n      return {\n        code: 200,\n        data: {\n          storeId: targetStoreId,\n          pageType,\n          components: presetComponents,\n          isPublished: false\n        },\n        message: '已重置为预设配置'\n      }\n    },\n    {\n      body: t.Object({\n        storeId: t.Optional(t.Number()),\n        pageType: t.Optional(t.String())\n      })\n    }\n  )\n\n  // 获取组件类型列表\n  .get('/component-types', async ({ query }) => {\n    const { pageType } = query\n\n    // 如果指定了页面类型，过滤出可用的组件\n    let types = [...COMPONENT_TYPES]\n    if (pageType) {\n      types = types.filter((t) => {\n        // 如果组件没有availableIn限制，则所有页面可用\n        if (!('availableIn' in t) || !t.availableIn) return true\n        // 否则检查是否在可用页面列表中\n        return (t.availableIn as readonly string[]).includes(pageType)\n      })\n    }\n\n    return { code: 200, data: types }\n  })\n\n  // 获取页面类型列表\n  .get('/page-types', async () => {\n    return { code: 200, data: PAGE_TYPES }\n  })\n\nexport const pageConfigRoutes = new Elysia({ prefix: '/api/page-configs' })\n  .use(publicRoutes)\n  .use(adminRoutes)\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\printers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\products.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\promotions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'count' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":34},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'pagination' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":26,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":36},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'requirePermission' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'logOperation' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Elysia, t } from 'elysia'\nimport { eq, and, gte, lte, count, desc } from 'drizzle-orm'\nimport { db, promotions } from '../db'\nimport { success, error, pagination } from '../lib/utils'\nimport { requirePermission } from '../lib/auth'\nimport { logOperation } from '../lib/operation-log'\n\n// 满减规则类型\ninterface FullReduceRule {\n  tiers: { min: number; discount: number }[]\n}\n\n// 折扣规则类型\ninterface DiscountRule {\n  discount: number // 0.8 表示8折\n  maxDiscount?: number\n}\n\n// 第二份半价规则类型\ninterface SecondHalfPriceRule {\n  discountRate: number // 0.5 表示半价，0.3 表示3折\n  maxItems?: number // 可选：最多享受优惠的商品数量\n}\n\n// 满件折扣规则类型\ninterface QuantityDiscountRule {\n  tiers: Array<{\n    minQuantity: number // 最低购买数量\n    discount: number // 折扣率 (0.9 = 9折)\n  }>\n  applicableProducts?: number[] // 适用商品ID（可选）\n  applicableCategories?: number[] // 适用分类ID（可选）\n}\n\n// 买一送一规则类型\ninterface BuyOneGetOneRule {\n  buyProductId: number // 购买商品ID\n  getProductId: number // 赠送商品ID（可与购买商品相同）\n  buyQuantity: number // 购买数量（默认1）\n  getQuantity: number // 赠送数量（默认1）\n  maxSets?: number // 最多享受几组（可选，防止薅羊毛）\n  getProductPrice?: number // 赠品价格（用于计算折扣金额）\n}\n\n// 计算满减优惠\nexport function calculateFullReduceDiscount(amount: number, rules: FullReduceRule): number {\n  const sortedTiers = [...rules.tiers].sort((a, b) => b.min - a.min)\n  for (const tier of sortedTiers) {\n    if (amount >= tier.min) {\n      return tier.discount\n    }\n  }\n  return 0\n}\n\n// 计算折扣优惠\nexport function calculateDiscountAmount(amount: number, rules: DiscountRule): number {\n  const discount = amount * (1 - rules.discount)\n  if (rules.maxDiscount && discount > rules.maxDiscount) {\n    return rules.maxDiscount\n  }\n  return discount\n}\n\n// 计算第二份半价优惠\nexport function calculateSecondHalfPriceDiscount(\n  items: Array<{ price: number; quantity: number }>,\n  rules: SecondHalfPriceRule\n): number {\n  // 按价格降序排序，优先对高价商品打折\n  const sortedItems = [...items].sort((a, b) => b.price - a.price)\n\n  let totalDiscount = 0\n  let discountedCount = 0\n  const maxItems = rules.maxItems || Infinity\n\n  for (const item of sortedItems) {\n    // 每2个为一组，第2个享受折扣\n    const pairs = Math.floor(item.quantity / 2)\n    const itemsToDiscount = Math.min(pairs, maxItems - discountedCount)\n\n    if (itemsToDiscount <= 0) break\n\n    // 计算折扣金额\n    totalDiscount += item.price * (1 - rules.discountRate) * itemsToDiscount\n    discountedCount += itemsToDiscount\n  }\n\n  return totalDiscount\n}\n\n// 计算满件折扣优惠\nexport function calculateQuantityDiscountAmount(\n  items: Array<{ productId?: number; categoryId?: number; price: number; quantity: number }>,\n  rules: QuantityDiscountRule\n): number {\n  // 筛选适用商品\n  let eligibleItems = items\n\n  if (rules.applicableProducts && rules.applicableProducts.length > 0) {\n    eligibleItems = items.filter(\n      (item) => item.productId && rules.applicableProducts!.includes(item.productId)\n    )\n  } else if (rules.applicableCategories && rules.applicableCategories.length > 0) {\n    eligibleItems = items.filter(\n      (item) => item.categoryId && rules.applicableCategories!.includes(item.categoryId)\n    )\n  }\n\n  // 计算总数量\n  const totalQuantity = eligibleItems.reduce((sum, item) => sum + item.quantity, 0)\n\n  // 找到适用的最高折扣档位\n  const sortedTiers = [...rules.tiers].sort((a, b) => b.minQuantity - a.minQuantity)\n  const applicableTier = sortedTiers.find((tier) => totalQuantity >= tier.minQuantity)\n\n  if (!applicableTier) {\n    return 0 // 未达到最低数量要求\n  }\n\n  // 计算折扣金额\n  const totalAmount = eligibleItems.reduce((sum, item) => sum + item.price * item.quantity, 0)\n  const discountAmount = totalAmount * (1 - applicableTier.discount)\n\n  return discountAmount\n}\n\n// 计算买一送一优惠\nexport function calculateBuyOneGetOneDiscount(\n  items: Array<{ productId?: number; price: number; quantity: number }>,\n  rules: BuyOneGetOneRule\n): { discount: number; freeItems: Array<{ productId: number; quantity: number }> } {\n  // 找到购买的商品\n  const buyItem = items.find((item) => item.productId === rules.buyProductId)\n\n  if (!buyItem) {\n    return { discount: 0, freeItems: [] }\n  }\n\n  // 计算可以获得多少组赠品\n  const sets = Math.floor(buyItem.quantity / rules.buyQuantity)\n  const maxSets = rules.maxSets || Infinity\n  const actualSets = Math.min(sets, maxSets)\n\n  if (actualSets === 0) {\n    return { discount: 0, freeItems: [] }\n  }\n\n  // 计算赠品数量\n  const freeQuantity = actualSets * rules.getQuantity\n\n  // 计算折扣金额（赠品的价值）\n  const freeItemPrice = rules.getProductPrice || 0\n  const discount = freeItemPrice * freeQuantity\n\n  return {\n    discount,\n    freeItems: [\n      {\n        productId: rules.getProductId,\n        quantity: freeQuantity\n      }\n    ]\n  }\n}\n\n// 核心计算逻辑，供 Cart 和 Order 复用\nexport async function calculatePromotionsForOrder(\n  storeId: number,\n  items: Array<{ productId?: number; categoryId?: number; price: number; quantity: number }>,\n  amount: number,\n  isNewUser: boolean = false\n) {\n  const now = new Date()\n\n  // 获取有效活动\n  const conditions = [\n    eq(promotions.status, 'ACTIVE'),\n    lte(promotions.startTime, now),\n    gte(promotions.endTime, now),\n    eq(promotions.storeId, storeId)\n  ]\n\n  const activePromotions = await db\n    .select()\n    .from(promotions)\n    .where(and(...conditions))\n    .orderBy(desc(promotions.priority))\n\n  let totalDiscount = 0\n  const appliedPromotions: Array<{\n    id: number\n    name: string\n    type: string\n    discount: number\n  }> = []\n\n  for (const promo of activePromotions) {\n    // 新人专享检查\n    if (promo.type === 'NEW_USER' && !isNewUser) {\n      continue\n    }\n\n    let discount = 0\n\n    if (promo.type === 'FULL_REDUCE') {\n      const rules = promo.rules as unknown as FullReduceRule\n      discount = calculateFullReduceDiscount(amount, rules)\n    } else if (promo.type === 'DISCOUNT' || promo.type === 'TIME_LIMITED') {\n      const rules = promo.rules as unknown as DiscountRule\n      discount = calculateDiscountAmount(amount, rules)\n    } else if (promo.type === 'NEW_USER') {\n      const rules = promo.rules as { discount: number }\n      discount = rules.discount\n    } else if (promo.type === 'SECOND_HALF_PRICE') {\n      const rules = promo.rules as unknown as SecondHalfPriceRule\n      discount = calculateSecondHalfPriceDiscount(items || [], rules)\n    } else if (promo.type === 'QUANTITY_DISCOUNT') {\n      const rules = promo.rules as unknown as QuantityDiscountRule\n      discount = calculateQuantityDiscountAmount(items || [], rules)\n    } else if (promo.type === 'BUY_ONE_GET_ONE') {\n      const rules = promo.rules as unknown as BuyOneGetOneRule\n      const result = calculateBuyOneGetOneDiscount(items || [], rules)\n      discount = result.discount\n      // Note: freeItems info is available in result.freeItems if needed\n    }\n\n    if (discount > 0) {\n      appliedPromotions.push({\n        id: promo.id,\n        name: promo.name,\n        type: promo.type,\n        discount: Math.round(discount * 100) / 100\n      })\n\n      totalDiscount += discount\n\n      // 如果不可叠加，只应用第一个\n      if (!promo.stackable) {\n        break\n      }\n    }\n  }\n\n  return {\n    originalAmount: amount,\n    totalDiscount: Math.round(totalDiscount * 100) / 100,\n    finalAmount: Math.round((amount - totalDiscount) * 100) / 100,\n    appliedPromotions\n  }\n}\n\nexport const promotionRoutes = new Elysia({ prefix: '/api/promotions' })\n  // ... (existing endpoints) ...\n\n  // 计算订单优惠（预览）\n  .post(\n    '/calculate',\n    async ({ body }) => {\n      const { storeId, amount, isNewUser, items } = body\n      return success(\n        await calculatePromotionsForOrder(storeId || 0, items || [], amount, isNewUser)\n      )\n    },\n    {\n      body: t.Object({\n        storeId: t.Optional(t.Number()),\n        amount: t.Number({ minimum: 0 }),\n        isNewUser: t.Optional(t.Boolean()),\n        items: t.Optional(\n          t.Array(\n            t.Object({\n              productId: t.Optional(t.Number()),\n              categoryId: t.Optional(t.Number()),\n              price: t.Number(),\n              quantity: t.Number()\n            })\n          )\n        )\n      }),\n      detail: { tags: ['Promotions'], summary: '计算订单优惠' }\n    }\n  )\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\roles.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\settings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\staff.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\stores.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\tables.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\routes\\upload.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\services\\print-service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\services\\stock-service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\test\\coupons.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\test\\helpers.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":70,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2058,2061],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2058,2061],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server'\n\nimport { createHmac } from 'crypto'\nimport type { JWTPayload } from '../lib/auth'\n\n// Minimal HS256 JWT signer for tests; avoids pulling extra deps.\nexport function createTestToken(payload: JWTPayload, secret: string) {\n  const header = { alg: 'HS256', typ: 'JWT' }\n  const b64 = (obj: unknown) => Buffer.from(JSON.stringify(obj)).toString('base64url')\n  const data = `${b64(header)}.${b64(payload)}`\n  const hmac = createHmac('sha256', secret)\n  hmac.update(data)\n  const signature = hmac.digest('base64url')\n  return `${data}.${signature}`\n}\n\n// Very small in-memory Redis stub to satisfy rate-limit/idempotency paths.\nexport class MemoryRedis {\n  store = new Map<string, { value: string; expireAt: number | null }>()\n\n  private now() {\n    return Date.now()\n  }\n\n  async incr(key: string) {\n    const current = this.store.get(key)\n    const value = current ? Number(current.value) + 1 : 1\n    this.store.set(key, { value: value.toString(), expireAt: current?.expireAt ?? null })\n    return value\n  }\n\n  async expire(key: string, ttlSeconds: number) {\n    const current = this.store.get(key)\n    if (!current) return 0\n    this.store.set(key, { ...current, expireAt: this.now() + ttlSeconds * 1000 })\n    return 1\n  }\n\n  async get(key: string) {\n    const current = this.store.get(key)\n    if (!current) return null\n    if (current.expireAt && current.expireAt < this.now()) {\n      this.store.delete(key)\n      return null\n    }\n    return current.value\n  }\n\n  async set(key: string, value: string, mode?: string, ttl?: number, nx?: string) {\n    const existing = await this.get(key)\n    if (nx === 'NX' && existing !== null) {\n      return null\n    }\n\n    let expireAt: number | null = null\n    if (mode === 'EX' && ttl) {\n      expireAt = this.now() + ttl * 1000\n    }\n    this.store.set(key, { value, expireAt })\n    return 'OK'\n  }\n\n  async del(key: string) {\n    return this.store.delete(key) ? 1 : 0\n  }\n}\n\n// Helper to expose MemoryRedis via global for tests\nexport function injectTestRedis(instance: MemoryRedis) {\n  ;(globalThis as any).__TEST_REDIS__ = instance\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\test\\members.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\test\\tables.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\test\\upload.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\types\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\worker\\print-worker.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[647,650],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[647,650],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":79,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2166,2169],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2166,2169],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { eq } from 'drizzle-orm'\nimport { db, printJobs, printers, orders, orderItems } from '../db'\nimport redis, { PRINT_STREAM_KEY } from '../lib/redis'\nimport { broadcastToStore, WS_EVENTS } from '../ws'\n\nconst CONSUMER_GROUP = 'print_workers'\nconst CONSUMER_NAME = `worker_${process.pid}`\nconst MAX_RETRIES = 3\n\ninterface PrintJobMessage {\n  orderId: number\n  printerId: number\n  jobId: number\n}\n\n// 创建消费者组\nasync function ensureConsumerGroup() {\n  if (!redis) return false\n\n  try {\n    await redis.xgroup('CREATE', PRINT_STREAM_KEY, CONSUMER_GROUP, '0', 'MKSTREAM')\n    console.log(`✅ Consumer group ${CONSUMER_GROUP} created`)\n  } catch (e: any) {\n    if (!e.message?.includes('BUSYGROUP')) {\n      console.error('Failed to create consumer group:', e)\n      return false\n    }\n  }\n  return true\n}\n\n// 处理打印任务\nasync function processPrintJob(job: PrintJobMessage): Promise<boolean> {\n  const { orderId, printerId, jobId } = job\n\n  try {\n    // 获取打印机信息\n    const [printer] = await db.select().from(printers).where(eq(printers.id, printerId)).limit(1)\n\n    if (!printer) {\n      console.error(`Printer ${printerId} not found`)\n      return false\n    }\n\n    // 获取订单和订单项\n    const [order] = await db.select().from(orders).where(eq(orders.id, orderId)).limit(1)\n    const items = await db.select().from(orderItems).where(eq(orderItems.orderId, orderId))\n\n    if (!order) {\n      console.error(`Order ${orderId} not found`)\n      return false\n    }\n\n    // 构建打印内容\n    const printContent = buildPrintContent(order, items, printer)\n\n    // 更新任务状态为打印中\n    await db.update(printJobs).set({ status: 'PRINTING' }).where(eq(printJobs.id, jobId))\n\n    // 调用打印机 API（这里模拟）\n    const success = await sendToPrinter(printer, printContent)\n\n    if (success) {\n      // 更新任务状态为成功\n      await db.update(printJobs).set({ status: 'SUCCESS' }).where(eq(printJobs.id, jobId))\n\n      // 广播打印完成通知\n      broadcastToStore(order.storeId, WS_EVENTS.PRINT_JOB_COMPLETED, {\n        jobId,\n        orderId,\n        printerName: printer.name\n      })\n\n      console.log(`✅ Print job ${jobId} completed`)\n      return true\n    } else {\n      throw new Error('Printer API failed')\n    }\n  } catch (e: any) {\n    console.error(`❌ Print job ${jobId} failed:`, e.message)\n\n    // 获取当前重试次数\n    const [currentJob] = await db.select().from(printJobs).where(eq(printJobs.id, jobId)).limit(1)\n\n    if (currentJob && currentJob.retries < MAX_RETRIES) {\n      // 增加重试次数\n      await db\n        .update(printJobs)\n        .set({\n          status: 'PENDING',\n          retries: currentJob.retries + 1,\n          error: e.message\n        })\n        .where(eq(printJobs.id, jobId))\n\n      // 重新加入队列\n      if (redis) {\n        await redis.xadd(PRINT_STREAM_KEY, '*', 'data', JSON.stringify(job))\n      }\n    } else {\n      // 标记为死信\n      await db\n        .update(printJobs)\n        .set({\n          status: 'DEAD',\n          error: `Max retries exceeded: ${e.message}`\n        })\n        .where(eq(printJobs.id, jobId))\n\n      // 广播打印失败通知\n      const [order] = await db.select().from(orders).where(eq(orders.id, orderId)).limit(1)\n      if (order) {\n        broadcastToStore(order.storeId, WS_EVENTS.PRINT_JOB_FAILED, {\n          jobId,\n          orderId,\n          error: e.message\n        })\n      }\n    }\n\n    return false\n  }\n}\n\n// 构建打印内容\nfunction buildPrintContent(\n  order: typeof orders.$inferSelect,\n  items: (typeof orderItems.$inferSelect)[],\n  printer: typeof printers.$inferSelect\n) {\n  const lines: string[] = []\n\n  lines.push('================================')\n  lines.push(`       ${printer.type === 'KITCHEN' ? '后厨' : '收银'}小票`)\n  lines.push('================================')\n  lines.push(`订单号: ${order.orderNo}`)\n  lines.push(`下单时间: ${order.createdAt.toLocaleString('zh-CN')}`)\n  lines.push('--------------------------------')\n\n  items.forEach((item) => {\n    const snapshot = item.snapshot as { name: string; specs?: Record<string, string> }\n    let itemLine = `${snapshot.name} x${item.quantity}`\n    if (snapshot.specs && Object.keys(snapshot.specs).length > 0) {\n      itemLine += ` (${Object.values(snapshot.specs).join('/')})`\n    }\n    lines.push(itemLine)\n\n    if (item.attributes) {\n      const attrs = item.attributes as { name: string; value: string }[]\n      attrs.forEach((attr) => {\n        lines.push(`  - ${attr.name}: ${attr.value}`)\n      })\n    }\n  })\n\n  lines.push('--------------------------------')\n  lines.push(`合计: ¥${order.payAmount}`)\n  if (order.remark) {\n    lines.push(`备注: ${order.remark}`)\n  }\n  lines.push('================================')\n\n  return lines.join('\\n')\n}\n\n// 发送到打印机（模拟）\nasync function sendToPrinter(\n  printer: typeof printers.$inferSelect,\n  content: string\n): Promise<boolean> {\n  // 这里应该调用实际的打印机 API\n  // 例如：飞鹅云、易联云等\n  console.log(`📠 Sending to printer ${printer.sn}:`)\n  console.log(content)\n\n  // 模拟打印延迟\n  await new Promise((resolve) => setTimeout(resolve, 500))\n\n  // 模拟 95% 成功率\n  return Math.random() > 0.05\n}\n\n// 主循环\nasync function startWorker() {\n  console.log('🖨️ Print Worker starting...')\n\n  if (!redis) {\n    console.warn('⚠️ Redis not available, print worker disabled')\n    return\n  }\n\n  const groupCreated = await ensureConsumerGroup()\n  if (!groupCreated) {\n    console.error('Failed to initialize consumer group')\n    return\n  }\n\n  console.log('🖨️ Print Worker started, waiting for jobs...')\n\n  while (true) {\n    try {\n      // 从 Stream 读取消息\n      const messages = (await redis.xreadgroup(\n        'GROUP',\n        CONSUMER_GROUP,\n        CONSUMER_NAME,\n        'COUNT',\n        10,\n        'BLOCK',\n        5000, // 5秒超时\n        'STREAMS',\n        PRINT_STREAM_KEY,\n        '>'\n      )) as [string, [string, string[]][]][] | null\n\n      if (!messages || messages.length === 0) continue\n\n      for (const [_stream, entries] of messages) {\n        for (const [messageId, fields] of entries) {\n          try {\n            const data = JSON.parse(fields[1] || '{}') as PrintJobMessage\n            const success = await processPrintJob(data)\n\n            if (success) {\n              // ACK 消息\n              await redis.xack(PRINT_STREAM_KEY, CONSUMER_GROUP, messageId)\n            }\n          } catch (e) {\n            console.error('Failed to process message:', e)\n          }\n        }\n      }\n    } catch (e) {\n      console.error('Worker error:', e)\n      await new Promise((resolve) => setTimeout(resolve, 1000))\n    }\n  }\n}\n\n// 导出启动函数\nexport { startWorker }\n\n// 如果直接运行此文件\nif (import.meta.main) {\n  startWorker()\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\darwi\\Desktop\\test\\api\\src\\ws\\index.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":5,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":5,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[155,158],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[155,158],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]