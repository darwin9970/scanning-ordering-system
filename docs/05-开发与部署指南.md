# 桌台扫码点单系统 - 开发与部署指南

## 一、开发环境搭建

### 1.1 系统要求

| 软件 | 版本要求 | 说明 |
|:---|:---|:---|
| Bun | 1.x | 包管理器和运行时 |
| PostgreSQL | 16+ | 主数据库 |
| Redis | 7.0+ | 缓存和消息队列 |
| Docker | 20.x+ | 容器化部署（可选） |
| Git | 2.x | 版本控制 |

### 1.2 技术栈

| 层级 | 技术栈 | 说明 |
|:---|:---|:---|
| 后台管理 | Next.js 16, TailwindCSS, React Query, Zustand | App Router, Server Components |
| API 服务 | Elysia, Drizzle ORM | 高性能 API，类型安全 ORM |
| 消息队列 | Redis Stream | 打印任务队列 |
| 实时通信 | WebSocket | 订单实时通知 |
| 数据库 | PostgreSQL 16 | 主数据库 |
| 缓存 | Redis 7 | 会话管理、共享购物车 |

### 1.3 安装 Bun

```bash
# Windows (PowerShell)
powershell -c "irm bun.sh/install.ps1 | iex"

# macOS / Linux
curl -fsSL https://bun.sh/install | bash
```

### 1.4 安装 PostgreSQL

下载地址: https://www.postgresql.org/download/

创建数据库:
```sql
CREATE DATABASE qr_order;
```

### 1.5 安装 Redis

- Windows: https://github.com/tporadowski/redis/releases
- macOS: `brew install redis`
- Linux: `apt install redis-server`

## 二、项目启动

### 2.1 克隆项目

```bash
cd your-workspace
# 项目已在本地创建
```

### 2.2 API 服务启动

```bash
cd api

# 1. 安装依赖
bun install

# 2. 复制环境变量
cp .env.example .env

# 3. 编辑 .env 文件
# DATABASE_URL="postgres://postgres:password@localhost:5432/qr_order"
# REDIS_URL="redis://localhost:6379"
# JWT_SECRET="your-secret-key"

# 4. 同步数据库结构
bun run db:push

# 5. 播种测试数据
bun run db:seed

# 6. 启动开发服务器
bun run dev

# 7. (可选) 启动打印 Worker
bun run worker:dev
```

API 服务运行在: http://localhost:4000
WebSocket: ws://localhost:4000/ws/store/:storeId

### 2.3 后台管理系统启动

```bash
cd admin

# 1. 安装依赖
bun install

# 2. 启动开发服务器
bun run dev
```

后台管理系统运行在: http://localhost:3000

### 2.4 验证安装

1. 访问 http://localhost:4000/swagger 查看 API 文档
2. 访问 http://localhost:3000/login 进入登录页
3. 使用测试账号登录: admin / admin123

## 三、开发流程

### 3.1 目录约定

```
api/
├── src/
│   ├── db/schema.ts      # Drizzle 数据模型
│   ├── routes/           # API 路由
│   ├── types/            # TypeScript 类型定义
│   ├── ws/               # WebSocket 模块
│   ├── worker/           # Worker 服务
│   └── services/         # 业务服务

admin/
├── app/dashboard/        # 页面
├── components/           # 组件
├── lib/api.ts            # API 客户端
├── types/                # 类型定义
└── store/                # Zustand 状态
```

### 3.2 添加新功能流程

**后端:**

1. 修改 `src/db/schema.ts` 添加数据模型
2. 运行 `bun run db:push` 同步数据库
3. 在 `src/routes/` 创建路由文件
4. 在 `src/types/index.ts` 添加类型定义
5. 在 `src/index.ts` 注册路由

**前端:**

1. 在 `types/index.ts` 添加对应类型
2. 在 `lib/api.ts` 添加 API 方法
3. 在 `app/dashboard/` 创建页面
4. 在 `components/layout/sidebar.tsx` 添加菜单

### 3.3 常用命令

**API 项目:**

```bash
bun run dev          # 启动开发服务器
bun run start        # 生产模式启动
bun run worker       # 启动打印 Worker
bun run db:push      # 同步数据库结构
bun run db:generate  # 生成迁移文件
bun run db:studio    # 打开 Drizzle Studio
bun run db:seed      # 播种测试数据
```

**Admin 项目:**

```bash
bun run dev          # 启动开发服务器
bun run build        # 构建生产版本
bun run start        # 启动生产服务器
bun run lint         # 代码检查
```

## 四、生产部署

### 4.1 Docker Compose 一键部署

```bash
# 1. 复制环境变量
cp .env.example .env

# 2. 编辑 .env 设置密码
# POSTGRES_PASSWORD=your_password
# JWT_SECRET=your_jwt_secret

# 3. 启动所有服务
docker-compose up -d

# 4. 初始化数据库
docker-compose exec api bun run db:push
docker-compose exec api bun run db:seed

# 5. 查看日志
docker-compose logs -f
```

### 4.2 服务说明

| 服务 | 端口 | 说明 |
|:---|:---|:---|
| postgres | 5432 | PostgreSQL 数据库 |
| redis | 6379 | Redis 缓存 |
| api | 4000 | API 服务 |
| worker | - | 打印任务 Worker |
| admin | 3000 | 后台管理系统 |

### 4.3 常用命令

```bash
# 停止服务
docker-compose down

# 重启服务
docker-compose restart

# 重新构建
docker-compose build --no-cache

# 查看服务状态
docker-compose ps

# 进入容器
docker-compose exec api sh
```

### 4.4 数据持久化

数据存储在 Docker volumes 中:
- `postgres_data`: 数据库文件
- `redis_data`: Redis 数据

### 4.5 Nginx 反向代理（可选）

启用生产环境 Nginx:

```bash
docker-compose --profile production up -d nginx
```

Nginx 配置位于 `nginx/nginx.conf`

## 五、环境变量说明

### 5.1 Docker Compose 环境变量

| 变量名 | 必填 | 说明 | 默认值 |
|:---|:---|:---|:---|
| POSTGRES_USER | 否 | 数据库用户 | postgres |
| POSTGRES_PASSWORD | 是 | 数据库密码 | postgres123 |
| POSTGRES_DB | 否 | 数据库名 | qr_order |
| JWT_SECRET | 是 | JWT 签名密钥 | - |

### 5.2 API 环境变量

| 变量名 | 必填 | 说明 | 示例 |
|:---|:---|:---|:---|
| DATABASE_URL | 是 | PostgreSQL 连接字符串 | postgres://user:pwd@localhost:5432/qr_order |
| REDIS_URL | 否 | Redis 连接字符串 | redis://localhost:6379 |
| JWT_SECRET | 是 | JWT 签名密钥 | your-super-secret-key |
| PORT | 否 | 服务端口 | 4000 |
| NODE_ENV | 否 | 环境模式 | development / production |

### 5.3 Admin 环境变量

| 变量名 | 必填 | 说明 | 示例 |
|:---|:---|:---|:---|
| NEXT_PUBLIC_API_URL | 否 | API 地址 | http://localhost:4000 |
| NEXT_PUBLIC_WS_URL | 否 | WebSocket 地址 | ws://localhost:4000 |

## 六、监控与运维

### 6.1 健康检查

```bash
# API 健康检查
curl http://localhost:4000/health

# 响应
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### 6.2 日志查看

```bash
# Docker 日志
docker-compose logs -f api
docker-compose logs -f admin

# 开发环境
# 控制台直接输出
```

### 6.3 数据库备份

```bash
# 导出数据库 (Docker)
docker-compose exec postgres pg_dump -U postgres qr_order > backup.sql

# 导入数据库
docker-compose exec -T postgres psql -U postgres qr_order < backup.sql
```

## 七、常见问题

### Q1: 数据库连接失败

检查:
- PostgreSQL 服务是否启动
- DATABASE_URL 格式是否正确
- 数据库用户权限

### Q2: Redis 连接失败

检查:
- Redis 服务是否启动 (可选，不影响核心功能)
- REDIS_URL 格式是否正确
- 防火墙端口

### Q3: 登录后跳转异常

检查:
- JWT_SECRET 是否配置
- Token 是否正确存储
- 浏览器 localStorage

### Q4: API 跨域问题

检查 API 的 CORS 配置:
```typescript
cors({
  origin: ["http://localhost:3000"],
  credentials: true,
})
```

## 八、联系支持

如遇问题，请检查:
1. 环境变量配置
2. 依赖安装完整性
3. 数据库/Redis 服务状态
4. 控制台错误日志
