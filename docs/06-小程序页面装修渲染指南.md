# 小程序页面装修渲染指南

## 1. JSON 数据结构

后台页面装修系统保存的 JSON 结构如下：

```typescript
interface PageComponent {
  id: string; // 组件唯一ID
  type: string; // 组件类型，如 'BANNER', 'TEXT', 'IMAGE' 等
  title?: string; // 组件标题（用于后台显示）
  visible: boolean; // 是否可见
  props: Record<string, unknown>; // 组件属性

  // 自由布局属性（关键！）
  x?: number; // X坐标（像素）
  y?: number; // Y坐标（像素）
  width?: number; // 宽度（像素）
  height?: number; // 高度（像素）
  zIndex?: number; // 层级（越大越靠前）
  locked?: boolean; // 是否锁定（仅后台使用）
}

interface PageConfig {
  components: PageComponent[];
  pageType: string; // 页面类型
  settings?: {
    // 页面级设置
    backgroundColor?: string;
    navBgColor?: string;
    navTextColor?: string;
  };
}
```

## 2. 小程序端渲染示例

### 2.1 获取页面配置

```javascript
// pages/home/home.js
Page({
  data: {
    components: [],
    pageSettings: {},
  },

  onLoad() {
    this.loadPageConfig();
  },

  async loadPageConfig() {
    const res = await wx.request({
      url: `${API_BASE}/api/stores/${storeId}/page-configs?pageType=HOME`,
      method: "GET",
    });

    if (res.data.success) {
      const { components, settings } = res.data.data;
      this.setData({
        components: components.filter((c) => c.visible), // 只渲染可见组件
        pageSettings: settings || {},
      });
    }
  },
});
```

### 2.2 WXML 模板渲染

```html
<!-- pages/home/home.wxml -->
<view
  class="page-container"
  style="background-color: {{pageSettings.backgroundColor || '#f5f5f5'}}"
>
  <!-- 自由布局容器 -->
  <view class="free-canvas" style="position: relative; min-height: 100vh;">
    <!-- 遍历组件，按 zIndex 排序 -->
    <block wx:for="{{components}}" wx:key="id">
      <view
        class="component-wrapper"
        style="
          position: absolute;
          left: {{item.x || 0}}px;
          top: {{item.y || 0}}px;
          width: {{item.width || 'auto'}}px;
          height: {{item.height || 'auto'}}px;
          z-index: {{item.zIndex || 1}};
        "
      >
        <!-- 根据组件类型渲染不同组件 -->
        <template
          is="{{item.type}}"
          data="{{...item.props, width: item.width, height: item.height}}"
        />
      </view>
    </block>
  </view>
</view>
```

### 2.3 组件模板定义

```html
<!-- components/page-components/index.wxml -->

<!-- 轮播图组件 -->
<template name="BANNER">
  <swiper
    class="banner-swiper"
    style="width: 100%; height: 100%;"
    indicator-dots="{{showDots}}"
    autoplay="{{autoplay}}"
    interval="{{interval || 3000}}"
    circular
  >
    <swiper-item wx:for="{{images}}" wx:key="index">
      <image
        src="{{item.url}}"
        mode="aspectFill"
        style="width: 100%; height: 100%;"
        bindtap="onBannerTap"
        data-link="{{item.link}}"
      />
    </swiper-item>
  </swiper>
</template>

<!-- 文本组件 -->
<template name="TEXT">
  <view
    class="text-component"
    style="
      font-size: {{fontSize || 14}}px;
      color: {{color || '#333'}};
      text-align: {{textAlign || 'left'}};
      line-height: {{lineHeight || 1.5}};
      padding: {{padding || 0}}px;
    "
  >
    {{content}}
  </view>
</template>

<!-- 图片组件 -->
<template name="IMAGE">
  <image
    src="{{src}}"
    mode="{{mode || 'aspectFill'}}"
    style="width: 100%; height: 100%; border-radius: {{borderRadius || 0}}px;"
    bindtap="onImageTap"
    data-link="{{link}}"
  />
</template>

<!-- 按钮组件 -->
<template name="BUTTON">
  <button
    class="custom-button"
    style="
      background-color: {{bgColor || '#ff6b35'}};
      color: {{textColor || '#fff'}};
      border-radius: {{borderRadius || 8}}px;
      font-size: {{fontSize || 14}}px;
      width: 100%;
      height: 100%;
    "
    bindtap="onButtonTap"
    data-action="{{action}}"
    data-link="{{link}}"
  >
    {{text}}
  </button>
</template>

<!-- 商品列表组件 -->
<template name="PRODUCT_LIST">
  <view class="product-list" style="display: flex; flex-wrap: wrap;">
    <view
      wx:for="{{products}}"
      wx:key="id"
      class="product-item"
      style="width: {{100 / columns}}%; padding: 8px;"
      bindtap="onProductTap"
      data-id="{{item.id}}"
    >
      <image src="{{item.image}}" mode="aspectFill" class="product-image" />
      <view class="product-name">{{item.name}}</view>
      <view class="product-price">¥{{item.price}}</view>
    </view>
  </view>
</template>
```

## 3. 坐标与尺寸转换

后台设计器使用 375px 宽度作为基准（iPhone 6/7/8），小程序端需要根据实际屏幕宽度进行等比缩放：

```javascript
// utils/design.js
const systemInfo = wx.getSystemInfoSync();
const screenWidth = systemInfo.screenWidth;
const designWidth = 375; // 设计稿宽度

/**
 * 将设计稿尺寸转换为实际像素
 * @param {number} designPx 设计稿像素值
 * @returns {number} 实际像素值
 */
export function toRealPx(designPx) {
  return (designPx / designWidth) * screenWidth;
}

/**
 * 转换组件的位置和尺寸
 * @param {Object} component 组件数据
 * @returns {Object} 转换后的样式对象
 */
export function convertComponentStyle(component) {
  return {
    left: toRealPx(component.x || 0),
    top: toRealPx(component.y || 0),
    width: toRealPx(component.width || 200),
    height: toRealPx(component.height || 100),
    zIndex: component.zIndex || 1,
  };
}
```

### 使用示例

```javascript
// pages/home/home.js
import { convertComponentStyle } from "../../utils/design";

Page({
  data: {
    components: [],
  },

  async loadPageConfig() {
    const res = await api.getPageConfig("HOME");
    const components = res.components.map((comp) => ({
      ...comp,
      style: convertComponentStyle(comp),
    }));
    this.setData({ components });
  },
});
```

```html
<!-- pages/home/home.wxml -->
<view
  wx:for="{{components}}"
  wx:key="id"
  style="
    position: absolute;
    left: {{item.style.left}}px;
    top: {{item.style.top}}px;
    width: {{item.style.width}}px;
    height: {{item.style.height}}px;
    z-index: {{item.style.zIndex}};
  "
>
  <!-- 组件内容 -->
</view>
```

## 4. API 接口

### 获取页面配置

```
GET /api/stores/:storeId/page-configs?pageType=HOME
```

响应示例：

```json
{
  "success": true,
  "data": {
    "id": 1,
    "storeId": 1,
    "pageType": "HOME",
    "components": [
      {
        "id": "comp_1733823456789_abc",
        "type": "BANNER",
        "title": "轮播图",
        "visible": true,
        "x": 0,
        "y": 0,
        "width": 375,
        "height": 200,
        "zIndex": 1,
        "props": {
          "images": [
            { "url": "/uploads/banner1.jpg", "link": "/pages/detail?id=1" },
            { "url": "/uploads/banner2.jpg", "link": "/pages/detail?id=2" }
          ],
          "autoplay": true,
          "interval": 3000,
          "showDots": true
        }
      },
      {
        "id": "comp_1733823456790_def",
        "type": "TEXT",
        "title": "标题文字",
        "visible": true,
        "x": 16,
        "y": 220,
        "width": 343,
        "height": 40,
        "zIndex": 2,
        "props": {
          "content": "今日特惠",
          "fontSize": 20,
          "color": "#333333",
          "textAlign": "center"
        }
      },
      {
        "id": "comp_1733823456791_ghi",
        "type": "PRODUCT_LIST",
        "title": "商品列表",
        "visible": true,
        "x": 0,
        "y": 280,
        "width": 375,
        "height": 400,
        "zIndex": 1,
        "props": {
          "columns": 2,
          "showPrice": true,
          "categoryId": null
        }
      }
    ],
    "isPublished": true,
    "settings": {
      "backgroundColor": "#f5f5f5",
      "navBgColor": "#ffffff",
      "navTextColor": "black"
    }
  }
}
```

## 5. 注意事项

1. **坐标系统**：后台使用左上角为原点的坐标系统，x 向右增加，y 向下增加
2. **层级顺序**：zIndex 越大，组件越靠前显示
3. **可见性过滤**：渲染时需过滤 `visible: false` 的组件
4. **锁定状态**：`locked` 属性仅用于后台编辑，小程序端无需处理
5. **响应式适配**：建议使用 rpx 或等比缩放确保在不同设备上显示一致
6. **性能优化**：组件较多时考虑使用虚拟列表或懒加载

## 6. 预设页面配置

### 6.1 默认布局

系统为首页和点餐页提供了精美的预设布局，商家首次使用时会自动加载。

**首页预设布局**（酒馆主题）:
- 轮播图（全宽，180px）
- 公告栏（深棕色背景，金色文字）
- 搜索模块（左右留白 16px）
- 快捷导航（精酿、威士忌、鸡尾酒、小食）
- 焦点入口（"立即点单"按钮）
- 热销推荐（🍺 人气推荐）

**点餐页预设布局**:
- 轮播图
- 公告栏
- 点单组件（完整点餐功能）

### 6.2 显示逻辑

小程序端显示逻辑：

1. **优先显示配置的布局**：如果门店有已发布的页面配置，显示配置的组件
2. **保留核心功能**：首页保留扫码功能，点餐页保留点餐功能
3. **向后兼容**：如果没有配置，显示默认布局

### 6.3 初始化预设配置

```bash
# 为所有门店初始化预设配置
cd api
bun run init:page-configs
```

### 6.4 在后台修改配置

1. 访问：`/dashboard/stores/[id]/design`
2. 选择对应的页面类型（首页/点餐页）
3. 拖拽组件、调整配置
4. 点击"保存"保存草稿
5. 点击"发布"使配置生效

## 7. 组件类型清单

| 类型         | 说明       | 默认尺寸 | 分类     |
| :----------- | :--------- | :------- | :------- |
| BANNER       | 轮播图     | 375×180  | 标准组件 |
| TEXT         | 文本       | 375×40   | 基础元素 |
| IMAGE        | 图片       | 375×150  | 基础元素 |
| SEARCH       | 搜索框     | 375×40   | 标准组件 |
| NAV_GRID     | 宫格导航   | 375×100  | 标准组件 |
| NOTICE       | 公告       | 375×40   | 标准组件 |
| FOCUS_ENTRY  | 焦点入口   | 375×60   | 极简组件 |
| HOT_PRODUCTS | 热销商品   | 375×200  | 标准组件 |
| NEW_PRODUCTS | 新品推荐   | 375×200  | 标准组件 |
| COUPON       | 优惠券     | 375×100  | 标准组件 |
| SPACER       | 分隔符     | 375×20   | 标准组件 |
| ORDER_COMPONENT | 点单组件 | 375×400  | 专属组件 |
