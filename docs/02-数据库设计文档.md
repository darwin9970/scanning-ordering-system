# 桌台扫码点单系统 - 数据库设计文档

## 一、数据库概述

- **数据库类型**: PostgreSQL 16+
- **ORM**: Drizzle ORM
- **字符集**: UTF-8

## 二、实体关系图 (ER Diagram)

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   admins    │────>│   stores    │<────│   tables    │
└─────────────┘     └─────────────┘     └─────────────┘
                          │                    │
                          ▼                    ▼
                    ┌─────────────┐     ┌─────────────┐
                    │ categories  │     │   orders    │
                    └─────────────┘     └─────────────┘
                          │                    │
                          ▼                    ▼
                    ┌─────────────┐     ┌─────────────┐
                    │  products   │     │ order_items │
                    └─────────────┘     └─────────────┘
                          │
            ┌─────────────┼─────────────┐
            ▼             ▼             ▼
   ┌────────────────┐ ┌────────────┐ ┌──────────────────┐
   │product_variants│ │ attributes │ │category_printers │
   └────────────────┘ └────────────┘ └──────────────────┘
```

## 三、数据表详细设计

### 3.1 管理员表 (admins)

| 字段 | 类型 | 说明 |
|:---|:---|:---|
| id | Int | 主键 |
| username | String(50) | 用户名，唯一 |
| password | String(255) | 密码（SHA256加密） |
| name | String(50) | 姓名 |
| role | Enum | 角色: SUPER_ADMIN/OWNER/STAFF |
| store_id | Int? | 所属门店（超管为空） |
| status | Enum | 状态: ACTIVE/INACTIVE |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

### 3.2 用户表 (users)

| 字段 | 类型 | 说明 |
|:---|:---|:---|
| id | Int | 主键 |
| openid | String(100) | 微信 OpenID，唯一 |
| unionid | String(100)? | 微信 UnionID |
| nickname | String(50)? | 昵称 |
| avatar | String(255)? | 头像 URL |
| phone | String(20)? | 手机号 |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

### 3.3 会员表 (members)

| 字段 | 类型 | 说明 |
|:---|:---|:---|
| id | Int | 主键 |
| user_id | Int | 关联用户，唯一 |
| level | Int | 会员等级 (默认1) |
| points | Int | 当前积分 (默认0) |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

### 3.4 门店表 (stores)

| 字段 | 类型 | 说明 |
|:---|:---|:---|
| id | Int | 主键 |
| name | String(100) | 门店名称 |
| address | String(255)? | 门店地址 |
| phone | String(20)? | 联系电话 |
| latitude | Decimal(10,8)? | 纬度 |
| longitude | Decimal(11,8)? | 经度 |
| logo | String(255)? | Logo URL |
| status | Enum | 状态: ACTIVE/CLOSED/DISABLED |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

### 3.5 桌台表 (tables)

| 字段 | 类型 | 说明 |
|:---|:---|:---|
| id | Int | 主键 |
| store_id | Int | 所属门店 |
| name | String(50) | 桌台号 (如 A01) |
| capacity | Int | 容纳人数 (默认4) |
| qr_code | String(100) | 二维码 Token，唯一 |
| status | Enum | 状态: FREE/OCCUPIED/RESERVED |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

### 3.6 分类表 (categories)

| 字段 | 类型 | 说明 |
|:---|:---|:---|
| id | Int | 主键 |
| store_id | Int | 所属门店 |
| name | String(50) | 分类名称 |
| sort | Int | 排序 (默认0) |
| icon | String(255)? | 图标 URL |
| status | Enum | 状态: ACTIVE/INACTIVE |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

### 3.7 商品表 (products) - SPU

| 字段 | 类型 | 说明 |
|:---|:---|:---|
| id | Int | 主键 |
| store_id | Int | 所属门店 |
| category_id | Int | 所属分类 |
| name | String(100) | 商品名称 |
| description | Text? | 商品描述 |
| image_url | String(255)? | 商品图片 |
| type | Enum | 类型: SINGLE/VARIANT |
| base_price | Decimal(10,2) | 基础价格 |
| sales | Int | 销量 (默认0) |
| sort | Int | 排序 (默认0) |
| status | Enum | 状态: AVAILABLE/SOLDOUT/HIDDEN |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

### 3.8 商品规格表 (product_variants) - SKU

| 字段 | 类型 | 说明 |
|:---|:---|:---|
| id | Int | 主键 |
| product_id | Int | 关联商品 |
| specs | Json | 规格组合 {"size":"大","temp":"冰"} |
| price | Decimal(10,2) | 规格价格 |
| stock | Int | 库存 (-1表示无限) |
| status | Enum | 状态: ACTIVE/INACTIVE |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

### 3.9 商品属性表 (product_attributes)

| 字段 | 类型 | 说明 |
|:---|:---|:---|
| id | Int | 主键 |
| product_id | Int | 关联商品 |
| name | String(50) | 属性名 (如：辣度) |
| options | Json | 选项列表 ["微辣","中辣"] |
| required | Boolean | 是否必选 (默认false) |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

### 3.10 打印机表 (printers)

| 字段 | 类型 | 说明 |
|:---|:---|:---|
| id | Int | 主键 |
| store_id | Int | 所属门店 |
| sn | String(100) | 打印机 SN 码 |
| key | String(100) | 打印机密钥 |
| name | String(50) | 备注名 |
| type | Enum | 类型: KITCHEN/CASHIER/BAR |
| status | Enum | 状态: ACTIVE/INACTIVE |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

### 3.11 分类-打印机关联表 (category_printers)

| 字段 | 类型 | 说明 |
|:---|:---|:---|
| category_id | Int | 分类 ID (联合主键) |
| printer_id | Int | 打印机 ID (联合主键) |

### 3.12 订单表 (orders)

| 字段 | 类型 | 说明 |
|:---|:---|:---|
| id | Int | 主键 |
| order_no | String(50) | 订单号，唯一 |
| store_id | Int | 所属门店 |
| table_id | Int | 桌台 ID |
| user_id | Int? | 用户 ID |
| total_amount | Decimal(10,2) | 订单总金额 |
| pay_amount | Decimal(10,2) | 实付金额 |
| discount | Decimal(10,2) | 优惠金额 (默认0) |
| status | Enum | 状态: PENDING/PAID/PREPARING/COMPLETED/CANCELLED/REFUNDED |
| pay_time | DateTime? | 支付时间 |
| remark | String(255)? | 备注 |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

### 3.13 订单项表 (order_items)

| 字段 | 类型 | 说明 |
|:---|:---|:---|
| id | Int | 主键 |
| order_id | Int | 关联订单 |
| product_variant_id | Int | 关联 SKU |
| quantity | Int | 数量 |
| price | Decimal(10,2) | 下单时单价 |
| snapshot | Json | 商品快照 {name,categoryName,specs} |
| attributes | Json? | 选中属性 [{"name":"辣度","value":"微辣"}] |
| created_at | DateTime | 创建时间 |

### 3.14 打印任务表 (print_jobs)

| 字段 | 类型 | 说明 |
|:---|:---|:---|
| id | Int | 主键 |
| order_id | Int | 关联订单 |
| printer_id | Int | 打印机 ID |
| content | Json | 打印内容 |
| status | Enum | 状态: PENDING/PRINTING/SUCCESS/FAILED/DEAD |
| retries | Int | 重试次数 (默认0) |
| error | Text? | 错误信息 |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

## 四、索引设计

| 表 | 索引字段 | 类型 |
|:---|:---|:---|
| admins | username | UNIQUE |
| users | openid | UNIQUE |
| members | user_id | UNIQUE |
| tables | qr_code | UNIQUE |
| tables | store_id | INDEX |
| categories | store_id | INDEX |
| products | store_id | INDEX |
| products | category_id | INDEX |
| product_variants | product_id | INDEX |
| product_attributes | product_id | INDEX |
| printers | store_id | INDEX |
| orders | order_no | UNIQUE |
| orders | store_id | INDEX |
| orders | table_id | INDEX |
| orders | user_id | INDEX |
| orders | status | INDEX |
| order_items | order_id | INDEX |
| print_jobs | order_id | INDEX |
| print_jobs | status | INDEX |

## 五、枚举类型定义

```typescript
// 角色
enum Role {
  SUPER_ADMIN  // 超级管理员
  OWNER        // 店长
  STAFF        // 店员
}

// 通用状态
enum Status {
  ACTIVE
  INACTIVE
}

// 门店状态
enum StoreStatus {
  ACTIVE    // 营业中
  CLOSED    // 已打烊
  DISABLED  // 已停用
}

// 桌台状态
enum TableStatus {
  FREE      // 空闲
  OCCUPIED  // 使用中
  RESERVED  // 已预约
}

// 商品类型
enum ProductType {
  SINGLE   // 单品
  VARIANT  // 多规格
}

// 商品状态
enum ProductStatus {
  AVAILABLE  // 可售
  SOLDOUT    // 售罄
  HIDDEN     // 隐藏
}

// 打印机类型
enum PrinterType {
  KITCHEN  // 后厨
  CASHIER  // 收银
  BAR      // 吧台
}

// 订单状态
enum OrderStatus {
  PENDING    // 待支付
  PAID       // 已支付
  PREPARING  // 制作中
  COMPLETED  // 已完成
  CANCELLED  // 已取消
  REFUNDED   // 已退款
}

// 打印任务状态
enum PrintJobStatus {
  PENDING   // 待打印
  PRINTING  // 打印中
  SUCCESS   // 成功
  FAILED    // 失败
  DEAD      // 死信
}
```

## 六、数据库操作示例

### 6.1 查询门店商品（含规格）

```sql
SELECT p.*, pv.*, c.name as category_name
FROM products p
LEFT JOIN product_variants pv ON p.id = pv.product_id
LEFT JOIN categories c ON p.category_id = c.id
WHERE p.store_id = 1 AND p.status = 'AVAILABLE'
ORDER BY c.sort, p.sort;
```

### 6.2 统计今日营收

```sql
SELECT 
  COUNT(*) as order_count,
  SUM(pay_amount) as total_revenue
FROM orders
WHERE store_id = 1 
  AND status IN ('PAID', 'PREPARING', 'COMPLETED')
  AND DATE(created_at) = CURDATE();
```

### 6.3 热销商品排行

```sql
SELECT p.id, p.name, p.sales, c.name as category_name
FROM products p
LEFT JOIN categories c ON p.category_id = c.id
WHERE p.store_id = 1
ORDER BY p.sales DESC
LIMIT 10;
```
